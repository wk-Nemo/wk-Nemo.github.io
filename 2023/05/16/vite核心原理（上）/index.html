<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="构建工具是前端开发提效的重要工具，它拥有各种各样的功能，但是总结为一条就是——解决前端工程中的痛点。如下：  模块加载：按照制定的模块规范，加载文件 语法转译：ts转换js、scss转换css 产物质量：压缩代码、代码检测、tree-shaking 开发效率：热更新  1 模块化 模块化规范 构建工具解决的问题  在很多编程语言中，自身就具备了很好的文件和包管理机制，通过import、includ">
<meta property="og:type" content="article">
<meta property="og:title" content="vite核心原理（上）">
<meta property="og:url" content="http://example.com/2023/05/16/vite%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89/index.html">
<meta property="og:site_name" content="wk的博客">
<meta property="og:description" content="构建工具是前端开发提效的重要工具，它拥有各种各样的功能，但是总结为一条就是——解决前端工程中的痛点。如下：  模块加载：按照制定的模块规范，加载文件 语法转译：ts转换js、scss转换css 产物质量：压缩代码、代码检测、tree-shaking 开发效率：热更新  1 模块化 模块化规范 构建工具解决的问题  在很多编程语言中，自身就具备了很好的文件和包管理机制，通过import、includ">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7effc532c8c46b49fcf250f724e9e41~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f7c6e427c874515b7a7946c306d1225~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7424f96355c74ae595050e65e6563592~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6188a5ea1d314b199fd88a1e25a4724a~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81d34826c3a544a08bf08efa35b34763~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8c0d21817694bcf8170f404373c27a3~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b668a1fc3fd64a60aca3c81f47949f15~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f56a81a6cddc40eaa4fb70d3d7f99a63~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5fdcd95093904b2ab41230c566748ceb~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2023-05-16T01:30:09.000Z">
<meta property="article:modified_time" content="2023-05-16T01:57:44.244Z">
<meta property="article:author" content="wk">
<meta property="article:tag" content="构建工具">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7effc532c8c46b49fcf250f724e9e41~tplv-k3u1fbpfcp-watermark.image">


<link rel="canonical" href="http://example.com/2023/05/16/vite%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2023/05/16/vite%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89/","path":"2023/05/16/vite核心原理（上）/","title":"vite核心原理（上）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>vite核心原理（上） | wk的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">wk的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录技术、学习和生活的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">1 模块化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-vite%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">2 vite的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 热更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">2.1.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.1.2.</span> <span class="nav-text">客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-vite%E7%9A%84%E5%BF%AB%E4%B8%8E%E6%85%A2"><span class="nav-number">3.</span> <span class="nav-text">3 vite的快与慢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-vite%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB%EF%BC%9F"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 vite为什么快？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-vite%E4%B8%BA%E4%BB%80%E4%B9%88%E6%85%A2%EF%BC%9F"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 vite为什么慢？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-vite%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91"><span class="nav-number">4.</span> <span class="nav-text">4 vite插件开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">5.</span> <span class="nav-text">参考文章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">6.</span> <span class="nav-text"></span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wk"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">wk</p>
  <div class="site-description" itemprop="description">一个前端程序员</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wk-Nemo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wk-Nemo" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://juejin.cn/user/3122268755465879" title="掘金 → https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;3122268755465879" rel="noopener me" target="_blank">掘金</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/16/vite%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="vite核心原理（上） | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          vite核心原理（上）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-05-16 09:30:09 / Modified: 09:57:44" itemprop="dateCreated datePublished" datetime="2023-05-16T09:30:09+08:00">2023-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vite/" itemprop="url" rel="index"><span itemprop="name">Vite</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>构建工具是前端开发提效的重要工具，它拥有各种各样的功能，但是总结为一条就是——解决前端工程中的痛点。如下：</p>
<ul>
<li>模块加载：按照制定的模块规范，加载文件</li>
<li>语法转译：ts转换js、scss转换css</li>
<li>产物质量：压缩代码、代码检测、tree-shaking</li>
<li>开发效率：热更新</li>
</ul>
<h2 id="1-模块化"><a href="#1-模块化" class="headerlink" title="1 模块化"></a>1 模块化</h2><blockquote>
<p>模块化规范</p>
<p>构建工具解决的问题</p>
</blockquote>
<p>在很多编程语言中，自身就具备了很好的文件和包管理机制，通过import、include、require等等命令，可以引入其他模块、包或者文件。而js早期被认定为简单的网页脚本语言，做一些简单的表单验证或动画，那时候的代码量还是很少的，因此只需要将js写入script标签即可。但是随着前端和js的快速发展，js的代码越来越复杂，没有模块化会带来很多的问题，例如：代码的复用性、隔离性和可维护性等。举几个例子：</p>
<p><strong>一、早期的模块化手段</strong></p>
<p>早期模块化还没有诞生时，业界就已经产生了一些模块化开发的手段——<strong>文件划分</strong></p>
<p>文件划分是将应用的状态和逻辑分散到不同的文件中，最后通过script标签引入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// moudle-a.js</span></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;wukui&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// module-b.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">helloWorld</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script src=&quot;./modlue-a.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;./modlue-b.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        console.log(name)</span><br><span class="line">        helloWorld()</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这种方式存在如下两个问题：</p>
<ul>
<li><strong>依赖管理：</strong>文件之间存在加载顺序，当模块之间相互依赖时，随着模块的增加很难梳理清楚，还会产生运行时的错误</li>
<li><strong>隔离性：</strong>各模块之间的变量命名会产生冲突</li>
</ul>
<p><strong>二、超大文件的维护</strong></p>
<p>当代码行数越来越多时，逐渐就演变成了我们口中的💩山，代码变得越来越难以理解和维护，对程序员造成了极大的心智负担。模块化很好的解决了这个问题，通过合理的层次和逻辑划分，可以让代码之间的关联变得清晰，单个模块的职责明确，代码量自然就少了，可阅读性和维护性也随之而升。</p>
<p>举几个例子：</p>
<p>从较为宏观的角度来看，现代前端开发框架的模式MVVM(Model-View-ViewModel)，Model层由后端控制，View层由框架来控制，因此开发人员不需要关注数据数据的业务逻辑和DOM的操作，只需要专注于ViewModel处理相应的数据的状态即可。极大的促进了前后端的分离，也提升了前端的开发效率。</p>
<p>再细粒度的来看，会有一些状态管理工具，帮助我们将ViewModel分为服务层和逻辑层。服务层专注于和后端的交互，通过ajax拿到后端的数据。逻辑层负责处理数据，它不关心如何获取数据，只需要关注数据的状态变化。</p>
<p>除了代码层面，从代码的管理上也可以看到模块化的好处。vue2源码托管在src目录中，然后更具功能拆分出了然后依据功能拆分出了 compiler、core、platforms、server、sfc、shared等目录。而到了vue3，则是通过monorope的方式维护，将不同的功能拆分到不同的模块当中。事实上不止vue，随着monorope方案的成熟，越来越多的开源项目都在使用monorope的方式进行管理。</p>
<p><strong>三、CommonJS 横空出世，node应运而生</strong></p>
<p>2009年1月29日，Mozilla的工程师Kevin Dangoor发布了一篇文章《What Server Side JavaScript needs》，并在Google Groups中创建了一个ServerJS小组，旨在构建更好的JavaScript生态系统，包括服务器端、浏览器端，而后更名为CommonJS小组，发起了CommonJS的提案。当年年末，node基于CommonJS规范横空出世，node跟具模块的不同来源分为了三大类：</p>
<ul>
<li>内置模块：fs、path、http等</li>
<li>自定义模块：用户按照CommonJS规范创建的 js 文件</li>
<li>第三方模块：由第三方开发的模块，并使用npm进行管理</li>
</ul>
<p>凭借着node“单线程”和“天然异步API”下的高性能运行时，JavaScript正式的踏入了服务端领域。自CommonJS诞生以来，前端社区对模块化探索的脚步一直未停止，先后出现了AMD、CMD、UMD和ESModule等模块化规范，并诞生出了一系列的工具</p>
<ul>
<li>基于CommonJS规范：node</li>
<li>基于AMD规范：requireJS</li>
<li>基于CMD规范：SeaJS</li>
<li>基于ESModule：node、webpack、vite、浏览器原生支持</li>
</ul>
<p><strong>四、ESModule</strong></p>
<p>ES Module简称ESM，ESM是ES6的开发规范。ES6于2015年6月正式发布，目前已经被大部分主流浏览器原生支持，只要HTML中有type&#x3D;”module”属性的script标签，那么浏览器就会按照ES Module规范了来进行依赖加载和模块解析。Node最开始使用的是CommonJS规范，但自从v13.2.0之后也引入了ES Module机制。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7effc532c8c46b49fcf250f724e9e41~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f7c6e427c874515b7a7946c306d1225~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>1）导出模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> name = <span class="string">&#x27;wk&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">helloWorld</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// name.js</span></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;wk&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">helloWorld</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; name, helloWorld &#125;</span><br></pre></td></tr></table></figure>

<p>2）导入功能</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; name, helloWorld &#125; <span class="keyword">from</span> <span class="string">&#x27;./name.js&#x27;</span></span><br></pre></td></tr></table></figure>

<p>3）HTML应用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span> src=<span class="string">&quot;./name.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>4）默认导出导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// name.js</span></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;wk&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello.js 导出匿名函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> name <span class="keyword">from</span> <span class="string">&#x27;./name.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> helloWorld <span class="keyword">from</span> <span class="string">&#x27;./hello.js&#x27;</span></span><br></pre></td></tr></table></figure>

<p>5）as 避免命名冲突</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inside module.js</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  function1 <span class="keyword">as</span> newFunctionName,</span><br><span class="line">  function2 <span class="keyword">as</span> anotherNewFunctionName</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inside main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; newFunctionName, anotherNewFunctionName &#125; <span class="keyword">from</span> <span class="string">&#x27;/modules/module.js&#x27;</span>;</span><br><span class="line"><span class="comment">// inside module.js</span></span><br><span class="line"><span class="keyword">export</span> &#123; function1, function2 &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inside main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; function1 <span class="keyword">as</span> newFunctionName,</span><br><span class="line">         function2 <span class="keyword">as</span> anotherNewFunctionName &#125; <span class="keyword">from</span> <span class="string">&#x27;/modules/module.js&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>6）合并模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&#x27;a.js&#x27;</span></span><br><span class="line"><span class="keyword">export</span> &#123; name &#125; <span class="keyword">from</span> <span class="string">&#x27;name.js&#x27;</span></span><br><span class="line"><span class="keyword">export</span> &#123; helloWorld &#125; <span class="keyword">from</span> <span class="string">&#x27;./hello.js&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-vite的使用"><a href="#2-vite的使用" class="headerlink" title="2 vite的使用"></a>2 vite的使用</h2><blockquote>
<p>简介</p>
<p>项目搭建</p>
<p>配置</p>
</blockquote>
<p>vite作为新一代的构建工具，最突出的亮点就是极快的构建速度和热更新速度，大大的提升了研发效率，这一点会在后面详细介绍。除此之外，vite在其他方面也表现不俗。</p>
<p>这里使用vite搭建vue3项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm create vite</span><br></pre></td></tr></table></figure>

<p>目录:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7424f96355c74ae595050e65e6563592~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>package.json:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6188a5ea1d314b199fd88a1e25a4724a~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>项目安装和启动：虽然项目较小，但是vite构建完成的时间仅使用了789ms</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i // 安装</span><br><span class="line">npm run dev // 启动</span><br></pre></td></tr></table></figure>

<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81d34826c3a544a08bf08efa35b34763~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h3 id="2-1-热更新"><a href="#2-1-热更新" class="headerlink" title="2.1 热更新"></a>2.1 热更新</h3><p>Vite 提供了一套原生 ESM 的 **<a target="_blank" rel="noopener" href="https://cn.vitejs.dev/guide/api-hmr.html">HMR API</a>**。 具有 HMR 功能的框架可以利用该 API 提供即时、准确的更新，而无需重新加载页面或清除应用程序状态。Vite 内置了 HMR 到 <strong><a target="_blank" rel="noopener" href="https://github.com/vitejs/vite-plugin-vue/tree/main/packages/plugin-vue">Vue 单文件组件（SFC）</a></strong> 和 <strong><a target="_blank" rel="noopener" href="https://github.com/vitejs/vite-plugin-react/tree/main/packages/plugin-react">React Fast Refresh</a></strong> 中，当你通过 <strong><a target="_blank" rel="noopener" href="https://cn.vitejs.dev/guide/">create-vite</a></strong> 创建应用程序时，所选模板已经为你预先配置了这些。得益于浏览器原生支持ESM，当修改某个文件时，热更新基本不需要时间。这点会在下面详细描述。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8c0d21817694bcf8170f404373c27a3~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b668a1fc3fd64a60aca3c81f47949f15~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>vite的插件兼容了rollup的所有钩子。如果你的插件仅使用了这些钩子，那么该插件以 rollup-plugin- 前缀，表示该插件是兼容rollup的。</p>
<ul>
<li>服务器启动时被调用：options、buildStart</li>
<li>传入模块时被调用：resolveId、load、transform</li>
<li>服务器关闭时被调用：buildEnd、closeBundle</li>
</ul>
<p>除此之外，vite还提供了一些专属的钩子，这些钩子会被rollup忽略，这类插件以 vite-plugin- 前缀。</p>
<ul>
<li>解析vite配置前：config</li>
<li>解析vite配置后：configResolve</li>
<li>配置开发服务器：configureServer</li>
<li>转换index.html：transformIndexHtml</li>
<li>HMR处理：handleHotUpdate</li>
</ul>
<p>接下来从源码的角度来分析vite如何做到热更新。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f56a81a6cddc40eaa4fb70d3d7f99a63~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>node.js 本身提供了官方的 API 例如 fs.watch fs.watchFile 来监听文件的变化，vite 则使用了这些 API 更上层的封装模块<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/chokidar">chokidar</a>来进行文件系统的变动监听。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启监听</span></span><br><span class="line"><span class="keyword">const</span> watcher = chokidar.<span class="title function_">watch</span>(</span><br><span class="line">  <span class="comment">// config file dependencies and env file might be outside of root</span></span><br><span class="line">  [root, ...config.<span class="property">configFileDependencies</span>, config.<span class="property">envDir</span>],</span><br><span class="line">  resolvedWatchOptions,</span><br><span class="line">) <span class="keyword">as</span> <span class="title class_">FSWatcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发钩子函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onHMRUpdate</span> = <span class="keyword">async</span> (<span class="params">file: string, configOnly: boolean</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (serverConfig.<span class="property">hmr</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">handleHMRUpdate</span>(file, server, configOnly)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">        <span class="attr">err</span>: <span class="title function_">prepareError</span>(err),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件新增、删除触发钩子</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onFileAddUnlink</span> = <span class="keyword">async</span> (<span class="params">file: string</span>) =&gt; &#123;</span><br><span class="line">  file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">handleFileAddUnlink</span>(file, server)</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">onHMRUpdate</span>(file, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听文件变化</span></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">async</span> (file) =&gt; &#123;</span><br><span class="line">  file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">  <span class="keyword">if</span> (file.<span class="title function_">endsWith</span>(<span class="string">&#x27;/package.json&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">invalidatePackageData</span>(packageCache, file)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// invalidate module graph cache on file change</span></span><br><span class="line">  moduleGraph.<span class="title function_">onFileChange</span>(file)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">onHMRUpdate</span>(file, <span class="literal">false</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听新增文件</span></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, onFileAddUnlink)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听删除文件</span></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;unlink&#x27;</span>, onFileAddUnlink)</span><br></pre></td></tr></table></figure>

<p>当文件有变动时，vite会触发handleHotUpdate钩子，拿到处理后的上下文，并通过webSocket建立的通道告知浏览器进行刷新或者加载文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行钩子函数，获取上下文</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> hook <span class="keyword">of</span> config.<span class="title function_">getSortedPluginHooks</span>(<span class="string">&#x27;handleHotUpdate&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> filteredModules = <span class="keyword">await</span> <span class="title function_">hook</span>(hmrContext)</span><br><span class="line">  <span class="keyword">if</span> (filteredModules) &#123;</span><br><span class="line">    hmrContext.<span class="property">modules</span> = filteredModules</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 通知重新加载</span></span><br><span class="line"><span class="keyword">if</span> (!hmrContext.<span class="property">modules</span>.<span class="property">length</span>) &#123;</span><br><span class="line">  <span class="comment">// html file cannot be hot updated</span></span><br><span class="line">  <span class="keyword">if</span> (file.<span class="title function_">endsWith</span>(<span class="string">&#x27;.html&#x27;</span>)) &#123;</span><br><span class="line">    config.<span class="property">logger</span>.<span class="title function_">info</span>(colors.<span class="title function_">green</span>(<span class="string">`page reload `</span>) + colors.<span class="title function_">dim</span>(shortFile), &#123;</span><br><span class="line">      <span class="attr">clear</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;full-reload&#x27;</span>,</span><br><span class="line">      <span class="attr">path</span>: config.<span class="property">server</span>.<span class="property">middlewareMode</span></span><br><span class="line">      ? <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      : <span class="string">&#x27;/&#x27;</span> + <span class="title function_">normalizePath</span>(path.<span class="title function_">relative</span>(config.<span class="property">root</span>, file)),</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// loaded but not in the module graph, probably not js</span></span><br><span class="line">    <span class="title function_">debugHmr</span>(<span class="string">`[no modules matched] <span class="subst">$&#123;colors.dim(shortFile)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知更新</span></span><br><span class="line"><span class="keyword">if</span> (updates.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="title function_">debugHmr</span>(colors.<span class="title function_">yellow</span>(<span class="string">`no update happened `</span>) + colors.<span class="title function_">dim</span>(file))</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">config.<span class="property">logger</span>.<span class="title function_">info</span>(</span><br><span class="line">  colors.<span class="title function_">green</span>(<span class="string">`hmr update `</span>) +</span><br><span class="line">  colors.<span class="title function_">dim</span>([...<span class="keyword">new</span> <span class="title class_">Set</span>(updates.<span class="title function_">map</span>(<span class="function">(<span class="params">u</span>) =&gt;</span> u.<span class="property">path</span>))].<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>)),</span><br><span class="line">  &#123; <span class="attr">clear</span>: !afterInvalidation, <span class="attr">timestamp</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">)</span><br><span class="line">ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">  updates,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>浏览器在整个系统扮演着客户端的角色，vite通过transformIndexHtml的hook将客户端代码插入了index.html</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5fdcd95093904b2ab41230c566748ceb~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>客户端接受到消息后，会根据服务端发送的消息进行处理。会根据不同情况，进行请求文件再刷新或者是直接刷新。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;update&#x27;</span>:</span><br><span class="line">      <span class="title function_">notifyListeners</span>(<span class="string">&#x27;vite:beforeUpdate&#x27;</span>, payload)</span><br><span class="line">      <span class="comment">// if this is the first update and there&#x27;s already an error overlay, it</span></span><br><span class="line">      <span class="comment">// means the page opened with existing server compile error and the whole</span></span><br><span class="line">      <span class="comment">// module script failed to load (since one of the nested imports is 500).</span></span><br><span class="line">      <span class="comment">// in this case a normal update won&#x27;t work and a full reload is needed.</span></span><br><span class="line">      <span class="keyword">if</span> (isFirstUpdate &amp;&amp; <span class="title function_">hasErrorOverlay</span>()) &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">clearErrorOverlay</span>()</span><br><span class="line">        isFirstUpdate = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">        payload.<span class="property">updates</span>.<span class="title function_">map</span>(<span class="keyword">async</span> (update): <span class="title class_">Promise</span>&lt;<span class="keyword">void</span>&gt; =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (update.<span class="property">type</span> === <span class="string">&#x27;js-update&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">queueUpdate</span>(<span class="title function_">fetchUpdate</span>(update))</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// css-update</span></span><br><span class="line">          <span class="comment">// this is only sent when a css file referenced with &lt;link&gt; is updated</span></span><br><span class="line">          <span class="keyword">const</span> &#123; path, timestamp &#125; = update</span><br><span class="line">          <span class="keyword">const</span> searchUrl = <span class="title function_">cleanUrl</span>(path)</span><br><span class="line">          <span class="comment">// can&#x27;t use querySelector with `[href*=]` here since the link may be</span></span><br><span class="line">          <span class="comment">// using relative paths so we need to use link.href to grab the full</span></span><br><span class="line">          <span class="comment">// URL for the include check.</span></span><br><span class="line">          <span class="keyword">const</span> el = <span class="title class_">Array</span>.<span class="title function_">from</span>(</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">querySelectorAll</span>&lt;<span class="title class_">HTMLLinkElement</span>&gt;(<span class="string">&#x27;link&#x27;</span>),</span><br><span class="line">          ).<span class="title function_">find</span>(</span><br><span class="line">            <span class="function">(<span class="params">e</span>) =&gt;</span></span><br><span class="line">              !outdatedLinkTags.<span class="title function_">has</span>(e) &amp;&amp; <span class="title function_">cleanUrl</span>(e.<span class="property">href</span>).<span class="title function_">includes</span>(searchUrl),</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!el) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> newPath = <span class="string">`<span class="subst">$&#123;base&#125;</span><span class="subst">$&#123;searchUrl.slice(<span class="number">1</span>)&#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">            searchUrl.includes(<span class="string">&#x27;?&#x27;</span>) ? <span class="string">&#x27;&amp;&#x27;</span> : <span class="string">&#x27;?&#x27;</span></span></span></span><br><span class="line"><span class="subst"><span class="string">          &#125;</span>t=<span class="subst">$&#123;timestamp&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// rather than swapping the href on the existing tag, we will</span></span><br><span class="line">          <span class="comment">// create a new link tag. Once the new stylesheet has loaded we</span></span><br><span class="line">          <span class="comment">// will remove the existing link tag. This removes a Flash Of</span></span><br><span class="line">          <span class="comment">// Unstyled Content that can occur when swapping out the tag href</span></span><br><span class="line">          <span class="comment">// directly, as the new stylesheet has not yet been loaded.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> newLinkTag = el.<span class="title function_">cloneNode</span>() <span class="keyword">as</span> <span class="title class_">HTMLLinkElement</span></span><br><span class="line">            newLinkTag.<span class="property">href</span> = <span class="keyword">new</span> <span class="title function_">URL</span>(newPath, el.<span class="property">href</span>).<span class="property">href</span></span><br><span class="line">            <span class="keyword">const</span> <span class="title function_">removeOldEl</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">              el.<span class="title function_">remove</span>()</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">debug</span>(<span class="string">`[vite] css hot updated: <span class="subst">$&#123;searchUrl&#125;</span>`</span>)</span><br><span class="line">              <span class="title function_">resolve</span>()</span><br><span class="line">            &#125;</span><br><span class="line">            newLinkTag.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, removeOldEl)</span><br><span class="line">            newLinkTag.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, removeOldEl)</span><br><span class="line">            outdatedLinkTags.<span class="title function_">add</span>(el)</span><br><span class="line">            el.<span class="title function_">after</span>(newLinkTag)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;),</span><br><span class="line">      )</span><br><span class="line">      <span class="title function_">notifyListeners</span>(<span class="string">&#x27;vite:afterUpdate&#x27;</span>, payload)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;full-reload&#x27;</span>:</span><br><span class="line">      <span class="title function_">notifyListeners</span>(<span class="string">&#x27;vite:beforeFullReload&#x27;</span>, payload)</span><br><span class="line">      <span class="keyword">if</span> (payload.<span class="property">path</span> &amp;&amp; payload.<span class="property">path</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;.html&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// if html file is edited, only reload the page if the browser is</span></span><br><span class="line">        <span class="comment">// currently on that page.</span></span><br><span class="line">        <span class="keyword">const</span> pagePath = <span class="built_in">decodeURI</span>(location.<span class="property">pathname</span>)</span><br><span class="line">        <span class="keyword">const</span> payloadPath = base + payload.<span class="property">path</span>.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          pagePath === payloadPath ||</span><br><span class="line">          payload.<span class="property">path</span> === <span class="string">&#x27;/index.html&#x27;</span> ||</span><br><span class="line">          (pagePath.<span class="title function_">endsWith</span>(<span class="string">&#x27;/&#x27;</span>) &amp;&amp; pagePath + <span class="string">&#x27;index.html&#x27;</span> === payloadPath)</span><br><span class="line">        ) &#123;</span><br><span class="line">          location.<span class="title function_">reload</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        location.<span class="title function_">reload</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="3-vite的快与慢"><a href="#3-vite的快与慢" class="headerlink" title="3 vite的快与慢"></a>3 vite的快与慢</h2><blockquote>
<p>冷启动、热更新</p>
<p>首屏渲染、懒加载</p>
</blockquote>
<h3 id="3-1-vite为什么快？"><a href="#3-1-vite为什么快？" class="headerlink" title="3.1 vite为什么快？"></a>3.1 vite为什么快？</h3><p>vite给人的第一印象就是快，快速的构建，快速的热更新，大幅度的提升了前端开发的效率。而这主要归功于：1）基于浏览器支持ES的实现 2）高性能引擎ESBuild</p>
<p><strong>一、基于浏览器支持ES的实现</strong></p>
<p><strong>二、高性能引擎ESBuild</strong></p>
<h3 id="3-2-vite为什么慢？"><a href="#3-2-vite为什么慢？" class="headerlink" title="3.2 vite为什么慢？"></a>3.2 vite为什么慢？</h3><p>成也萧何，败也萧何。因为传统构建工具的打包工作交给了浏览器处理，因此在页面打开时需要大量的加载http请求，导致了vite构建开发环境下的产物首屏渲染和懒加载会很慢。然而vite在打包生产环境的产物时使用的rollup，因此不会存在首屏渲染和懒加载的问题。所以相比vite带来的极速构建速度，首屏渲染和懒加载带来的问题显得“微不足道”，而且针对这些问题，业界也有了对应的解决方案。</p>
<h2 id="4-vite插件开发"><a href="#4-vite插件开发" class="headerlink" title="4 vite插件开发"></a>4 vite插件开发</h2><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7068273153952186398#heading-7">详谈前端模块化这十四年的发展史：CommonJS、AMD、CMD、ES6</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/book/7050063811973218341/section/7050063812044685343">深入浅出 Vite</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7129041114174062628">漫谈构建工具(四): 为什么有人说 vite 快，有人却说 vite 慢？</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7067827608842403848#heading-3">十分钟带你了解vite插件开发</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6968793122029436959#heading-3">vite源码分析(4) :vite 热更新原理分析</a></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" rel="tag"># 构建工具</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/05/15/2023%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/" rel="prev" title="2023年度计划">
                  <i class="fa fa-chevron-left"></i> 2023年度计划
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wk</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
