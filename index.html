<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一个前端程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="wk的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="wk的博客">
<meta property="og:description" content="一个前端程序员">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="wk">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>wk的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">wk的博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录技术、学习和生活的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wk"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">wk</p>
  <div class="site-description" itemprop="description">一个前端程序员</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wk-Nemo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wk-Nemo" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://juejin.cn/user/3122268755465879" title="掘金 → https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;3122268755465879" rel="noopener me" target="_blank">掘金</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/15/2023%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/15/2023%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/" class="post-title-link" itemprop="url">2023年度计划</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-05-15 19:59:46" itemprop="dateCreated datePublished" datetime="2023-05-15T19:59:46+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-16 09:18:00" itemprop="dateModified" datetime="2023-05-16T09:18:00+08:00">2023-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">年度计划</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="日程安排"><a href="#日程安排" class="headerlink" title="日程安排"></a>日程安排</h2><ul>
<li>7.00-8.00  起床，洗漱</li>
<li>8.00-10.00  吃饭，上班、学习</li>
<li>10.00-11.40  工作</li>
<li>11.40-12.40  回家，做饭，吃饭</li>
<li>12.40-13.40  午睡</li>
<li>14.00-18.00  工作</li>
<li>18.00-19.00  晚饭休息</li>
<li>19.00-20.00  工作</li>
<li>20.00-22.00  回家，洗漱，收拾，准备午饭</li>
<li>22.00-23.30  娱乐</li>
<li>23.30  睡觉</li>
</ul>
<h2 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h2><p>计算机基础：</p>
<ul>
<li>计算机网络：看一本经典的书、做好相关笔记</li>
<li>算法：看一本经典的书、弄懂每个类型的算法的经典题型、做笔记</li>
</ul>
<p>前端：</p>
<ul>
<li>JavaScript：新知识点总结、工作中的经验总结<ul>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2022/03/21/js%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E2%80%94%E2%80%94%E5%81%A5%E5%A3%AE%E6%80%A7/">js代码质量——健壮性</a></li>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2022/03/23/js%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E2%80%94%E2%80%94%E9%80%BB%E8%BE%91%E6%AD%A3%E7%A1%AE%E6%80%A7/">js代码质量——逻辑正确性</a></li>
</ul>
</li>
<li>Node：基础知识笔记、原理学习总结、实战应用总结</li>
<li>Vue：Vue3原理学习、做笔记<ul>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2022/03/24/%E8%B7%9F%E7%9D%80%E3%80%8AVue.js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B%E5%AD%A6%E4%B9%A0Vue3%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/">跟着《Vue.js设计与实现》学习Vue3模板编译</a></li>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2022/07/17/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%8A%EF%BC%89/">vue3响应式系统作用与实现（上）</a></li>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2022/08/20/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%AD%EF%BC%89/">vue3响应式系统作用与实现（中）</a></li>
</ul>
</li>
<li>构建工具：工作总结、vite、webpack、总结</li>
<li>微信小程序：工作总结、原理、总结</li>
<li>web性能优化：工作总结、网上学习、笔记</li>
</ul>
<h2 id="游戏"><a href="#游戏" class="headerlink" title="游戏"></a>游戏</h2><p>单机：</p>
<ul>
<li>塞尔达传说：旷野之息</li>
<li>塞尔达传说：王国之泪</li>
<li>巫师3</li>
</ul>
<p>网游：</p>
<ul>
<li>LOL</li>
<li>CSGO</li>
<li>雀魂</li>
</ul>
<h2 id="旅游"><a href="#旅游" class="headerlink" title="旅游"></a>旅游</h2><ul>
<li>重庆</li>
<li>成都</li>
<li>青岛</li>
</ul>
<h2 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h2><ul>
<li>学做饭<ul>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2023/05/13/%E7%A8%8B%E5%BA%8F%E7%8C%BF%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97%E2%80%94%E2%80%94%E5%87%86%E5%A4%87%E7%AF%87/">程序猿烧饭指南——准备篇</a></li>
<li><a target="_blank" rel="noopener" href="https://wk-nemo.github.io/2023/05/13/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97%E2%80%94%E2%80%94%E7%89%9B%E6%8E%92%E7%81%AB%E9%94%85-%E9%9D%92%E6%A4%92%E7%82%92%E8%82%89%E4%B8%9D/">程序员烧饭指南——5月份指南</a></li>
</ul>
</li>
<li>滑雪</li>
<li>读书<ul>
<li>《富爸爸穷爸爸》</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/13/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97%E2%80%94%E2%80%945%E6%9C%88%E4%BB%BD%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/13/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97%E2%80%94%E2%80%945%E6%9C%88%E4%BB%BD%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">程序员烧饭指南——5月份指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-05-13 16:57:40" itemprop="dateCreated datePublished" datetime="2023-05-13T16:57:40+08:00">2023-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-16 09:18:19" itemprop="dateModified" datetime="2023-05-16T09:18:19+08:00">2023-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97/" itemprop="url" rel="index"><span itemprop="name">程序员烧饭指南</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="五月份美食"><a href="#五月份美食" class="headerlink" title="五月份美食"></a>五月份美食</h2><p>炒菜：</p>
<ul>
<li><p><input checked="" disabled="" type="checkbox"> 
青椒炒肉丝</p>
</li>
<li><p><input disabled="" type="checkbox"> 
小炒青菜</p>
</li>
<li><p><input disabled="" type="checkbox"> 
农家小炒肉</p>
</li>
<li><p><input disabled="" type="checkbox"> 
毛豆炒肉丝</p>
</li>
</ul>
<p>菜：</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 青椒肉丝面</li>
<li><input checked="" disabled="" type="checkbox"> 卤鸡蛋、鸡腿</li>
<li><input disabled="" type="checkbox"> 鸡蛋羹</li>
<li><input disabled="" type="checkbox"> 油焖大虾</li>
</ul>
<p>火锅：</p>
<ul>
<li><input disabled="" type="checkbox"> 牛排火锅</li>
</ul>
<p>汤：</p>
<ul>
<li><input disabled="" type="checkbox"> 西红柿鸡蛋汤</li>
<li><input disabled="" type="checkbox"> 海带玉米排骨汤</li>
</ul>
<h2 id="青椒炒肉丝"><a href="#青椒炒肉丝" class="headerlink" title="青椒炒肉丝"></a>青椒炒肉丝</h2><p>食材：</p>
<ul>
<li>青椒</li>
<li>五花肉</li>
<li>香干</li>
<li>蒜</li>
<li>调料：料酒、生抽、老抽、蚝油、淀粉、盐、鸡精</li>
</ul>
<p>步骤：</p>
<ul>
<li><p>青椒洗干净切成长条，大蒜切成丁</p>
</li>
<li><p>选用猪里脊肉，喜欢吃肥的可以使用五花肉</p>
<ul>
<li>将选用的肉切成肉丝</li>
<li>加入蒜丁（去腥）、料酒（去腥）、生抽（上色）、蚝油（提鲜）和红薯淀粉（嫩滑）腌制备用</li>
</ul>
</li>
<li><p>起锅烧油，油热后加入腌制好的肉丝，翻炒至出香味，盛出备用</p>
</li>
<li><p>锅中留底油，爆香蒜丁后，加入备好的青椒和香干，炒至断生</p>
<ul>
<li>不要炒时间长了，否则青椒不脆</li>
</ul>
</li>
<li><p>加入炒好的肉丝，适量的盐、鸡精进行翻炒一会</p>
</li>
<li><p>出锅</p>
</li>
</ul>
<p>成品：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46781dfb33d144bab7074fe793451c43~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h2 id="青椒肉丝面"><a href="#青椒肉丝面" class="headerlink" title="青椒肉丝面"></a>青椒肉丝面</h2><p>食材：</p>
<ul>
<li>炒好的青椒肉丝</li>
<li>小刀面或手工面</li>
<li>鸡蛋</li>
<li>葱花</li>
<li>调料：猪油、盐、胡椒粉、辣椒粉、生抽、蚝油</li>
</ul>
<p>步骤：</p>
<ul>
<li>锅中起水烧开后加入面条，煮5-7分钟左右</li>
<li>煮面时，碗中加入猪油、盐、胡椒粉、辣椒粉、生抽、蚝油、葱花</li>
<li>面煮好后，碗中加入开水，和下好的面条</li>
<li>煎一个鸡蛋</li>
<li>盖上青椒肉丝</li>
</ul>
<p>成品：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f34a2435681340df8dd741bafeccdd4b~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1433c6fa8c284765972b16da9da7eb80~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h2 id="牛排火锅"><a href="#牛排火锅" class="headerlink" title="牛排火锅"></a>牛排火锅</h2><p>食材：</p>
<ul>
<li>牛排</li>
<li>小葱</li>
<li>生姜</li>
<li>蒜子</li>
<li>干辣椒</li>
<li>火锅底料</li>
<li>调料：料酒、</li>
</ul>
<p>步骤：</p>
<ul>
<li>牛排+黄酒+小葱+生姜+焯水 ，直至水开</li>
<li>水开后，捞出来洗肉</li>
<li>锅中放入少许油  加入洗后的肉爆炒</li>
<li>加适量黄酒 、小醋 、生抽、老抽后，加水盖过肉，煮至水开</li>
<li>水开后加入火锅底料，生姜，蒜子，干辣椒</li>
<li>把肉和汤倒入锅，小火炖至软烂（2h），中间要去翻一下，避免糊锅</li>
</ul>
<p>成品：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/48f5907a789a48468c68209624a58eaa~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h2 id="卤鸡腿和鸡蛋"><a href="#卤鸡腿和鸡蛋" class="headerlink" title="卤鸡腿和鸡蛋"></a>卤鸡腿和鸡蛋</h2><p>食材：</p>
<ol>
<li>主食材：鸡腿、鸡蛋</li>
<li>去腥：葱，姜，蒜，料酒</li>
<li>汤底佐料：3粒八角，3片香叶，2片桂皮，5片干辣椒，一搓花椒，8粒冰糖，4勺生抽，2勺老抽，一勺黄豆酱，少许鸡精，两碗半水，</li>
</ol>
<p>步骤：</p>
<ul>
<li>葱，姜，蒜，料酒，4个鸡腿改刀，4个鸡蛋，冷水下锅</li>
<li>鸡腿水开后一会捞出，洗净浮沫，备用</li>
<li>鸡煮十分钟捞出，剥壳，备用</li>
<li>3粒八角，3片香叶，2片桂皮，5片干辣椒，一搓花椒，8粒冰糖，4勺生抽，2勺老抽，一勺黄豆酱，少许鸡精，两碗半水，备用鸡腿和鸡蛋</li>
<li>大火烧至水开</li>
<li>小火慢炖1h</li>
</ul>
<p>成品：巨香无比，这调料卤鞋底都好吃</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6e4262b61c64045bb8f319fdce1ea93~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/13/%E7%A8%8B%E5%BA%8F%E7%8C%BF%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97%E2%80%94%E2%80%94%E5%87%86%E5%A4%87%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/13/%E7%A8%8B%E5%BA%8F%E7%8C%BF%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97%E2%80%94%E2%80%94%E5%87%86%E5%A4%87%E7%AF%87/" class="post-title-link" itemprop="url">程序猿烧饭指南——准备篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-05-13 16:38:04" itemprop="dateCreated datePublished" datetime="2023-05-13T16:38:04+08:00">2023-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-15 09:41:32" itemprop="dateModified" datetime="2023-05-15T09:41:32+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%83%A7%E9%A5%AD%E6%8C%87%E5%8D%97/" itemprop="url" rel="index"><span itemprop="name">程序员烧饭指南</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="准备（共计花费751-4元）"><a href="#准备（共计花费751-4元）" class="headerlink" title="准备（共计花费751.4元）"></a>准备（共计花费751.4元）</h2><p>厨具：664元</p>
<ul>
<li>电饭煲：煮饭、粥</li>
<li>刀、砧板、剪刀：切菜</li>
<li>炒锅、铲子：炒菜、烧大菜、下面条、炒面</li>
<li>碗、碟、筷子、勺子：吃饭、装菜</li>
<li>调料盒、油壶：装调料</li>
</ul>
<p>调料：87.4元</p>
<ul>
<li>盐</li>
<li>糖</li>
<li>十三香</li>
<li>辣椒</li>
<li>鸡精、味精</li>
<li>生抽</li>
<li>老抽酱油</li>
<li>蚝油</li>
<li>料酒</li>
<li>醋</li>
<li>黄豆酱</li>
<li>豆瓣酱</li>
<li>淀粉</li>
<li>盐焗粉</li>
<li>火锅底料</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/20/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%AD%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/20/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%AD%EF%BC%89/" class="post-title-link" itemprop="url">vue3响应式系统作用与实现（中）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-20 15:53:18" itemprop="dateCreated datePublished" datetime="2022-08-20T15:53:18+08:00">2022-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:49:37" itemprop="dateModified" datetime="2023-05-07T17:49:37+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-调度执行"><a href="#0-调度执行" class="headerlink" title="0 调度执行"></a>0 调度执行</h2><p>可调度性是响应式系统非常重要的特性，它是指当<code>trigger</code>触发副作用函数重新执行时，有能力决定副作用函数执行的时机、次数和方式。实现可调度性，可以为用户设计一个选择参数<code>options</code>，它允许客户指定调度器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为副作用函数新增选项入口</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">effectFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>(effectFn)</span><br><span class="line">        activeEffect = effectFn</span><br><span class="line">        effectStack.<span class="title function_">push</span>(effectFn)</span><br><span class="line">        <span class="title function_">fn</span>()</span><br><span class="line">        effectStack.<span class="title function_">pop</span>()</span><br><span class="line">        activeEffect = effectStack[effectStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将options挂在到effectFn上</span></span><br><span class="line">    effectFn.<span class="property">options</span> = options</span><br><span class="line">    effectFn.<span class="property">deps</span> = []</span><br><span class="line">    <span class="title function_">effectFn</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> depsMap = bucket.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    effects &amp;&amp; effects.<span class="title function_">forEach</span>(<span class="function"><span class="params">effectFn</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(effectFn !== activeEffect) &#123;</span><br><span class="line">            effectsToRun.<span class="title function_">add</span>(effectFn)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effectFn</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 如果副作用函数存在调度器，则调用该调度器</span></span><br><span class="line">        <span class="keyword">if</span>(effectFn.<span class="property">options</span>.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effectFn.<span class="property">options</span>.<span class="title function_">scheduler</span>(effectFn)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则直接执行副作用函数</span></span><br><span class="line">            <span class="title function_">effectFn</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一、有了调度器，我们可以控制副作用函数执行的时机</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;...&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">foo</span>) &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">foo</span> += <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>上述代码没有加入调度器，执行结果如下：</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220724144941211.png" alt="image-20220724144941211"></p>
<p>给副作用函数添加调度器，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">foo</span>) &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">scheduler</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(fn)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>重新执行代码结果如下：</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220724145439211.png" alt="image-20220724145439211"></p>
<p>通过配置<code>scheduler</code>，使用<code>setTimeout</code>开启了一个宏任务来执行副作用函数，对副作用函数的<strong>再次执行的时机</strong>进行了控制。</p>
<p>二、有了调度器，我们可以控制副作用函数执行的次数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">foo</span>) &#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">foo</span>++</span><br><span class="line">obj.<span class="property">foo</span>++</span><br></pre></td></tr></table></figure>

<p>该代码的执行结果如下：</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220724150211462.png" alt="image-20220724150211462"></p>
<p>因为<code>obj.foo</code>进行了两次写操作，所以上述的副作用函数执行了两次，但如果我们并不关心中间的过程，只关心最后的结果，那么第二次打印就是多余的。下面使用调度器来实现此功能。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jobQueue = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"><span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> isFlushing = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushJob</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(isFlushing) <span class="keyword">return</span></span><br><span class="line">    isFlushing = <span class="literal">true</span></span><br><span class="line">    p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        jobQueue.<span class="title function_">forEach</span>(<span class="function"><span class="params">job</span> =&gt;</span> <span class="title function_">job</span>())</span><br><span class="line">    &#125;).<span class="property">finally</span> (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        isFlushing = <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">foo</span>) &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">scheduler</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">            jobQueue.<span class="title function_">add</span>(fn)</span><br><span class="line">            <span class="title function_">flushJob</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">foo</span>++</span><br><span class="line">obj.<span class="property">foo</span>++</span><br></pre></td></tr></table></figure>

<p>在该调度器下，代码的执行逻辑如下：</p>
<ul>
<li>执行同步任务<code>effect</code>函数，输出了<code>foo</code>的值1，触发了<code>track</code>，将副作用函数和该属性进行依赖绑定</li>
<li>执行同步任务<code>obj.foo++</code>，触发<code>trigger</code>，检查存在调度器，执行调度器<code>scheduler</code></li>
<li>将副作用函数加入<code>jobQueue</code>，设置<code>isFlushing</code>为<code>true</code>，将<code>jobQueue</code>的执行加入微任务队列</li>
<li>再次执行同步任务<code>obj.foo++</code>，触发<code>trigger</code>，检查存在调度器，执行调度器<code>scheduler</code></li>
<li>将副作用函数再次加入<code>jobQueue</code>，再次执行<code>flushJob</code><ul>
<li>因为<code>jobQueue</code>是<code>set</code>结构，和前一次添加的副作用函数一样，故不执行添加动作。</li>
<li>因为<code>isFlushing</code>为<code>true</code>，直接<code>return</code></li>
</ul>
</li>
<li>执行微任务<code> jobQueue.forEach(job =&gt; job())</code>，输出<code>foo</code>的值3</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220724152505285.png" alt="image-20220724152505285"></p>
<h2 id="1-计算属性computed"><a href="#1-计算属性computed" class="headerlink" title="1 计算属性computed"></a>1 计算属性computed</h2><p>计算属性用于描述和依赖响应式数据的逻辑，它具有<strong>缓存</strong>的特点，即依赖的响应式数据没有变化的话，无论如何访问该计算属性都不会重新计算。实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> value</span><br><span class="line">    <span class="keyword">let</span> dirty = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter, &#123;</span><br><span class="line">        <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 如果触发track，就会执行调度，设置dirty为true，重新执行</span></span><br><span class="line">        <span class="comment">// 如股不触发track，不会执行调度，dirty保持false，取值缓存</span></span><br><span class="line">        <span class="title function_">scheduler</span>(<span class="params"></span>) &#123;</span><br><span class="line">            dirty = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> obj = &#123;</span><br><span class="line">        <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span>(dirty) &#123;</span><br><span class="line">                value = <span class="title function_">effectFn</span>()</span><br><span class="line">                dirty = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">effectFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>(effectFn)</span><br><span class="line">        activeEffect = effectFn</span><br><span class="line">        effectStack.<span class="title function_">push</span>(effectFn)</span><br><span class="line">        <span class="comment">// 将结果存储到res，并返回</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="title function_">fn</span>()</span><br><span class="line">        effectStack.<span class="title function_">pop</span>()</span><br><span class="line">        activeEffect = effectStack[effectStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">    effectFn.<span class="property">options</span> = options</span><br><span class="line">    effectFn.<span class="property">deps</span> = []</span><br><span class="line">    <span class="comment">// 只有非 lazy 时，才执行</span></span><br><span class="line">    <span class="keyword">if</span>(!options.<span class="property">lazy</span>) &#123;</span><br><span class="line">        <span class="title function_">effectFn</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> effectFn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>computed属性通过设置lazy属性实现懒加载，只有当真正的访问该计算属性，才会执行副作用函数。</p>
<p>computed方法内置了dirty字段用于判断是否需要重新执行副作用函数：</p>
<ul>
<li>首次调用computed时，lazy为true，因此会执行副作用函数getter，设置dirty为false并将值存储在value中返回；</li>
<li>若副作用函数getter依赖的响应式数据没有变化，则不会触发scheduler，dirty依然为false，故访问computed不会执行副作用函数getter，直接返回缓存的值value；</li>
<li>若副作用函数getter依赖的响应式数据发生变化，则会触发scheduler，dirty变为true，访问computed重新执行副作用函数getter，并返回执行执行副作用函数getter后的value；</li>
</ul>
<p>看一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sumRes = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = obj.<span class="property">foo</span> + obj.<span class="property">bar</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;computed run!&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sumRes.<span class="property">value</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sumRes.<span class="property">value</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sumRes.<span class="property">value</span>)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">foo</span>++</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sumRes.<span class="property">value</span>)</span><br></pre></td></tr></table></figure>

<p>结果如下，符合预期。</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220818230818531.png" alt="image-20220818230818531"></p>
<p>但是现在的计算属性还不完善，当我们在另一个effect中读取computed属性时：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sumRes = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = obj.<span class="property">foo</span> + obj.<span class="property">bar</span></span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sumRes.<span class="property">value</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">foo</span>++</span><br></pre></td></tr></table></figure>

<p>当obj.foo修改时，我们期望副作用函数会重新执行，就如同我们在vue中使用计算属性时，希望计算属性变化时会重新渲染模板一样，但是上述代码并没有重新执行effect函数。因为计算属性是懒加载的，必须访问才能触发，对于计算属性的getter副作用函数而言，它内部访问的像原始数据只会把getter副作用函数收集为依赖，不会收集调用computed的副作用函数effect。修改起来也很简单，需要我们手动调用track进行跟踪；当计算属性依赖的响应式数据发生变化时，手动调用trigger触发响应：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> value</span><br><span class="line">    <span class="keyword">let</span> dirty = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter, &#123;</span><br><span class="line">        <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="title function_">scheduler</span>(<span class="params"></span>) &#123;</span><br><span class="line">            dirty = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 手动触发函数响应</span></span><br><span class="line">            <span class="title function_">trigger</span>(obj, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> obj = &#123;</span><br><span class="line">        <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span>(dirty) &#123;</span><br><span class="line">                value = <span class="title function_">effectFn</span>()</span><br><span class="line">                dirty = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 手动追踪</span></span><br><span class="line">            <span class="title function_">track</span>(obj, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220819002031612.png" alt="image-20220819002031612"></p>
<h2 id="2-侦听器watched"><a href="#2-侦听器watched" class="headerlink" title="2 侦听器watched"></a>2 侦听器watched</h2><p>在vue中，侦听器watched应该包含如下功能：监听数据变化（存储旧值的能力），并执行回调函数</p>
<table>
<thead>
<tr>
<th>划分层次</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>监听数据</td>
<td>1）监听响应式数据 <br />2）监听getter函数</td>
</tr>
<tr>
<td>从监听层次</td>
<td>1）浅监听：某个值的变化<br />2）深监听：对象的每个属性</td>
</tr>
<tr>
<td>第一次是否执行</td>
<td>1）回调懒执行：默认 <br />2）立即回调：immediate为true</td>
</tr>
<tr>
<td>回调执行时机</td>
<td>1）组件更新之前调用：默认，flush为pre<br />2）同步执行：flush为sync<br />3）组件更新后调用：flush为post</td>
</tr>
</tbody></table>
<h3 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h3><p>watch的本质就是观测一个响应式数据，并在数据发生变化时通知执行相应的回调函数。</p>
<ul>
<li>首先判断监听的数据是响应式数据还是getter函数<ul>
<li>响应式数据递归读取，建立依赖关系</li>
<li>getter函数直接执行</li>
</ul>
</li>
<li>lazy属性配合schedule使用，在数据变化时，触发回调函数，并且带上新老value</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> getter</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        getter = source</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newValue, oldValue</span><br><span class="line">    <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">getter</span>(),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 数据变化时，触发回调函数</span></span><br><span class="line">            <span class="title function_">scheduler</span>(<span class="params"></span>) &#123;</span><br><span class="line">                newValue = <span class="title function_">effectFn</span>()</span><br><span class="line">                <span class="title function_">cb</span>(newValue, oldValue)</span><br><span class="line">                oldValue = newValue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    oldValue = <span class="title function_">effectFn</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递归读取，建立依赖关系</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">traverse</span>(<span class="params">value, seen = <span class="keyword">new</span> <span class="built_in">Set</span>()</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> value !== <span class="string">&#x27;object&#x27;</span> || value ===<span class="literal">null</span> || seen.<span class="title function_">has</span>(value)) <span class="keyword">return</span></span><br><span class="line">        seen.<span class="title function_">add</span>(value)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> k <span class="keyword">in</span> value) &#123;</span><br><span class="line">            <span class="title function_">traverse</span>(value[k], seen)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="立即执行-amp-回调时机"><a href="#立即执行-amp-回调时机" class="headerlink" title="立即执行 &amp; 回调时机"></a>立即执行 &amp; 回调时机</h3><p>watch的回调函数一般只会在响应式数据变化时执行，而如果我们希望watch创建时立即执行一次回调函数，可以指定immediate为true。</p>
<ul>
<li>这里将执行回调的逻辑抽离出来，可以在不同的地方使用</li>
<li>immediate则立即执行一次回调，否则值设置oldValue</li>
<li>flush选项决定回调触发时的执行时机<ul>
<li>flush为pre，在组件更新之前调用，涉及组件更新时机，暂时无法模拟</li>
<li>flush不存在时相当于sync，即同步执行</li>
<li>flush为post，将回调放入微任务队列，实现异步延迟执行</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb, options</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> getter</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        getter = source</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递归读取，建立依赖关系</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">traverse</span>(<span class="params">value, seen = <span class="keyword">new</span> <span class="built_in">Set</span>()</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> value !== <span class="string">&#x27;object&#x27;</span> || value ===<span class="literal">null</span> || seen.<span class="title function_">has</span>(value)) <span class="keyword">return</span></span><br><span class="line">        seen.<span class="title function_">add</span>(value)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> k <span class="keyword">in</span> value) &#123;</span><br><span class="line">            <span class="title function_">traverse</span>(value[k], seen)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newValue, oldValue</span><br><span class="line">    <span class="comment">// 提取公共逻辑</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">job</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        newValue = <span class="title function_">effectFn</span>()</span><br><span class="line">        <span class="title function_">cb</span>(newValue, oldValue)</span><br><span class="line">        oldValue = newValue</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">getter</span>(),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 数据变化时，触发回调函数</span></span><br><span class="line">            <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(opeions.<span class="property">flush</span> === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">                    p.<span class="title function_">then</span>(job)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">job</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// immediate为true立即执行回调</span></span><br><span class="line">    <span class="keyword">if</span>(options.<span class="property">immediate</span>) &#123;</span><br><span class="line">        <span class="title function_">job</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldValue = <span class="title function_">effectFn</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="竞态问题-amp-过期的副作用"><a href="#竞态问题-amp-过期的副作用" class="headerlink" title="竞态问题 &amp; 过期的副作用"></a>竞态问题 &amp; 过期的副作用</h3><p>竞态问题通常在多进程或多线程中被提及，而在前端开发中，也会遇到类似的场景。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> finalData</span><br><span class="line"><span class="title function_">watch</span>(obj, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/path/to/request&#x27;</span>)</span><br><span class="line">    finalData = res</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上述代码中，通过修改obj的值触发回调，先后发出了两次请求A和B。我们期望的是finalData拿到最新的结果，也就是B返回的数据，但是若B的响应较快，则可能出现A响应数据后到的情况，并且将B返回的值给覆盖掉。</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220820152345561.png" alt="image-20220820152345561"></p>
<p>在vue中，watch函数的回调函数接受第三个参数onInvalidate，onInvalidate函数会在当前副作用函数过期时执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> finalData</span><br><span class="line"><span class="title function_">watch</span>(obj, <span class="keyword">async</span> (newValue, oldValue, onInvalidate) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> expired = <span class="literal">false</span></span><br><span class="line">    <span class="title function_">onInvalidate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        expired = <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/path/to/request&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!expired) &#123;</span><br><span class="line">        finalData = res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>onInvalidate实现的原理是什么呢？在watch每次检测到变更后，在副作用函数重新执行前，会调用我们通过onInvalidate函数注册的过期回调。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb, options</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> getter</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        getter = source</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递归读取，建立依赖关系</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">traverse</span>(<span class="params">value, seen = <span class="keyword">new</span> <span class="built_in">Set</span>()</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> value !== <span class="string">&#x27;object&#x27;</span> || value ===<span class="literal">null</span> || seen.<span class="title function_">has</span>(value)) <span class="keyword">return</span></span><br><span class="line">        seen.<span class="title function_">add</span>(value)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> k <span class="keyword">in</span> value) &#123;</span><br><span class="line">            <span class="title function_">traverse</span>(value[k], seen)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newValue, oldValue</span><br><span class="line">    <span class="keyword">let</span> cleanup <span class="comment">// 存储过期函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onInvalidate</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        cleanup = fn</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 提取公共逻辑</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">job</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        newValue = <span class="title function_">effectFn</span>()</span><br><span class="line">        <span class="comment">// 调用回调函数之前，先调用过期回调</span></span><br><span class="line">        <span class="keyword">if</span>(cleanup) &#123;</span><br><span class="line">            <span class="title function_">cleanup</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// onInvalidate作为第三个参数供用户使用</span></span><br><span class="line">        <span class="title function_">cb</span>(newValue, oldValue, onInvalidate)</span><br><span class="line">        oldValue = newValue</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">getter</span>(),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 数据变化时，触发回调函数</span></span><br><span class="line">            <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(opeions.<span class="property">flush</span> === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">                    p.<span class="title function_">then</span>(job)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">job</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// immediate为true立即执行回调</span></span><br><span class="line">    <span class="keyword">if</span>(options.<span class="property">immediate</span>) &#123;</span><br><span class="line">        <span class="title function_">job</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldValue = <span class="title function_">effectFn</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了上述的代码后，我们再看一个示例了解执行的顺序：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">obj.<span class="property">foo</span>++</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    obj.<span class="property">foo</span>++</span><br><span class="line">&#125;, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>在我们第一次修改foo时，cleanup为空，不触发过期回调，直接执行watch的回调函数</li>
<li>第一次执行watch回调时，设置expiredA为false，注册了过期回调cleanupA</li>
<li>第二次修改foo时，过期回调cleanup不为空，因此先执行cleanupA，设置expiredA为true，再执行回调函数</li>
<li>第二次执行watch回调时，设置expiredB为false，注册了过期回调cleanupB</li>
<li>B先响应，因为expiredB为false，设置finalData为B返回的值</li>
<li>A后响应，因为expiredA为true，不设置finalData的值</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220820154630971.png" alt="image-20220820154630971"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/23/2022%E6%AF%95%E4%B8%9A%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/23/2022%E6%AF%95%E4%B8%9A%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">2022毕业总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-23 21:55:29" itemprop="dateCreated datePublished" datetime="2022-07-23T21:55:29+08:00">2022-07-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:21:42" itemprop="dateModified" datetime="2023-05-07T17:21:42+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93%E6%84%9F%E6%83%B3/" itemprop="url" rel="index"><span itemprop="name">个人总结感想</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0 前言"></a>0 前言</h2><p>前几天，和同一届校招的同事吃饭的路上，我感叹道：“时间过的真快，虽然已经成为进入社会开始工作了，但是感觉自己好像还是一个学生。” </p>
<p>细细回想来，自己六月份大学毕业，七月份就匆匆来到北京入职，接踵而来的就是各式各样的手续、校招培训、接需求写代码。生活节奏快到没给我留足够的时间去适应学生到职场人的转变，没给自己留足够的时间去思考北京这个魔幻的城市对我而言意味着什么。</p>
<h2 id="1-我不再是学生了"><a href="#1-我不再是学生了" class="headerlink" title="1 我不再是学生了"></a>1 我不再是学生了</h2><p>标题“我不再是学生了”是物理意义上的，我毕业了，没有选择考研，没有选择再次经历高考那样的没日没夜的学习和焦虑。身边大多数的朋友和同学都选择了考研，而我却“逃避”了自己生命中一次拼搏的机会，没给自己留下失败的风险，但作为代价是我失去了三年的缓冲期，没有时间仔细思考“程序员”这份工作是否适合自己，没有机会为自己的未来画上更多的可能。</p>
<p>目前来看，“前端”悄无声息间成为了我接下来很长一段人生中无法脱离的词语。最初选择学习前端是为了自己毕业能找到养活自己的工作，学习的过程中让我认识了自己的不足，也对自己的专业有了更深的认识。在没有准备考研的一年中，我在秋招赛道上开始了一段属于自己无形的竞争，这期间也经常焦虑和失眠。现在想来，自己貌似还是没有逃避“失败的风险”。我从一开始就弄错了一件事情，想要拥有更好的东西，就避免不了逃离自己的舒适圈，加入互卷的千万大军中。</p>
<p>秋招结束后的两个月，我进入了自己的“疲软期”，简而言之就是就是开始“摆烂”。很多之前计划的事情都没有去实行，每天都在的奖励和犒劳自己过去辛苦的一年。这也无可厚非，长时间的高强度学习，松懈后会有摆烂的情况很常见，比如说高考结束的暑假，最重要的是能让自己的生活重新回到正常的轨迹。</p>
<h2 id="2-依然摆脱不了学习"><a href="#2-依然摆脱不了学习" class="headerlink" title="2 依然摆脱不了学习"></a>2 依然摆脱不了学习</h2><p>虽然不再是学生，但是依然摆脱不了学习，亲身体会了一部分“活到老，学到老”这句老话的魅力。言归正传，还是谈谈自己入职来的一些感受。因为之前参加过实习，所以主管和导师一直推荐我不参加公司的封培，来到公司第二周就开干需求。</p>
<p>结果打开需求一看，小程序和web。</p>
<p>我：“嗯，小程序和web，还可以。嗯？不对，我好像没有写过原生的小程序。”</p>
<p>导师：“没事，和vue差不多，写写就会了。”</p>
<p>我：“？”</p>
<p>心里想着，小程序之前没写过，还是先写web吧，拿到代码一看。</p>
<p>我：“wc，这组件要怎么用啊？这个语法怎么这么眼熟，它是不是认识我？”</p>
<p>最终还是为自己两个月的摆烂（一行代码没写过）付出了代价，花了半天时间又撸了一边vue文档和组件库文档后，才慢慢找回写代码的感觉，紧赶慢赶完成了自己的第一个web需求。小程序这边直也就直接硬着头皮往上干，全当vue写，不会的地方就查文档和谷歌。发生了n次以下情况：</p>
<p><code>wx:if</code>写成<code>v-if</code>，自己蒙圈半天，然后道：“这值明明是<code>true</code>啊，怎么不渲染啊？”</p>
<p>嗯，这两个星期的开发就是这样一个不太理想的开始，好在需求时间宽裕，加上自己底子不差，还是慢慢适应了“前端码农”的生活。</p>
<p>除了上面的小插曲，自己对技术的学习也是很迷茫，一会想学点node，一会又想看看构建工具。东一榔头，西一棒，最后啥都知道一点，但是啥又不知道。和导师进行了一次激情的聊天后总结了几点：</p>
<ul>
<li>技术必须服务业务，到了职业生涯后面，技术只是一种手段</li>
<li>技术是必须要花时间学习的，这是程序员的基本功</li>
<li>要花时间在某一点上用力，不能盲目的东看看西看看</li>
<li>在解决问题中学习会更高效，多去想想为什么，多刨根问底，而不是简单的去完成一个功能</li>
</ul>
<p>给我制定的试用期目标也很简单：</p>
<ul>
<li>独立完成公司的需求开发</li>
<li>可以没有技术上的贡献，但是要有技术上的学习</li>
<li>多思考，多总结，多积累</li>
</ul>
<p>我觉得这些事看起来简单，但是想要做好或者是超出预期还是有难度的，这些要求的背后本身就对个人的意志的一种筛选。我觉得令我敬佩的人，做出令我感到不可思议的事情，其实就是世界对这个人意志的筛选。当你选择了去做一件简单件事，并在这个过程中一直保持着自己的初心和意志，日积月累，慢慢达到的高度就会让他人感到不可思议。老板兴哥说过一句话：“马拉松的开始万人瞩目，终点还有鲜花和鼓掌，但是中间漫长的忍耐和坚持是没有人能看见的。”我觉得这中间的忍耐和坚持，就是世界在对个人意志的筛选，与此同时，你也选择了自己想要的成为的人。</p>
<p>最后鼓励自己一句：努力成为自己想成为的人。</p>
<h2 id="3-生活还是有诗和远方"><a href="#3-生活还是有诗和远方" class="headerlink" title="3 生活还是有诗和远方"></a>3 生活还是有诗和远方</h2><p>我这目前也算半只脚步入了社会，应该主动承担更多的责任。</p>
<p>对自己更负责一点，上大学后胖了四十斤，平时控制饮食，少喝碳酸饮料，多出去走走，多运动运动。自己开销小一点，尽量多存一些钱。</p>
<p>对女朋友更负责一点，异地恋本来就很难，如今又要三年，平时多陪陪聊天，有矛盾时多一点耐心，有空多和她一起去旅游。</p>
<p>对家庭更负责一点，多孝顺父母，再忙再累也抽时间和父母聊聊天，回家看看。</p>
<h2 id="4-Todo-List"><a href="#4-Todo-List" class="headerlink" title="4 Todo List"></a>4 Todo List</h2><p>最后给自己接下来的半年记一个Todo吧。</p>
<p>工作：</p>
<ul>
<li>掌握工作中用到的所有技能</li>
<li>认真做好自己的工作，多一点耐心和坚持</li>
<li>多思考、多总结、多积累</li>
</ul>
<p>技术：</p>
<ul>
<li>读完《Vue设计与实现》，并输出博客</li>
<li>学习构建工具<ul>
<li>vite学习，输出博客</li>
<li>webpack学习，输出博客</li>
<li>公司内部构建工具学习，争取能在性能上做一些优化</li>
</ul>
</li>
</ul>
<p>生活：</p>
<ul>
<li>减肥，控制饮食，目标瘦20斤</li>
<li>运动，每周跑步三次，篮球一次</li>
<li>父母，每周至少一次电话</li>
<li>对象，每天都要聊天，有时间就电话</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/17/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%8A%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/17/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%B8%8A%EF%BC%89/" class="post-title-link" itemprop="url">vue3响应式系统作用与实现（上）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-17 18:56:18" itemprop="dateCreated datePublished" datetime="2022-07-17T18:56:18+08:00">2022-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:49:25" itemprop="dateModified" datetime="2023-05-07T17:49:25+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-响应式数据和副作用函数"><a href="#0-响应式数据和副作用函数" class="headerlink" title="0 响应式数据和副作用函数"></a>0 响应式数据和副作用函数</h2><p>在了解响应式系统之前，先了解什么是<strong>副作用函数</strong>和<strong>响应式数据</strong>。</p>
<p>副作用函数：<code>effect</code>函数的执行会直接或者间接的影响其他函数的执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">effect1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerText</span> = <span class="string">&#x27;hello vue3&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> val = <span class="number">1</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    val = <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应式数据：当<code>obj.text</code>的值变化后，副作用函数能够重新执行，也就是重新设置<code>body</code>的<code>innerText</code>属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerText</span> = obj.<span class="property">text</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 执行此代码时，effect函数重新执行</span></span><br><span class="line">opj.<span class="property">text</span> = <span class="string">&#x27;hello wk&#x27;</span></span><br></pre></td></tr></table></figure>



<p>实现一个简单的响应式系统：</p>
<ul>
<li>当<code>effect</code>执行时，触发<code>obj.text</code>的<strong>读操作</strong>，将<code>effect</code>函数存储到<code>bucket</code>数据结构中。</li>
<li>当<code>obj.text</code>被修改时，触发<code>obj.text</code>的<strong>写操作</strong>，从<code>bucket</code>中拿出<code>effect</code>函数并执行。</li>
</ul>
<p>在vue2中，是通过<code>Object.defineProperty</code>函数实现的，在vue3中，使用了ES5+的代理对象<code>Proxy</code>实现。下面使用<code>Proxy</code>实现一个简单的响应式系统：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储副作用函数的数据结构，目前使用的是Set</span></span><br><span class="line"><span class="keyword">const</span> bucket = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Proxy对data进行代理</span></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="comment">// 拦截读的操作</span></span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="comment">// 将副作用函数添加到bucket中</span></span><br><span class="line">        bucket.<span class="title function_">add</span>(effect)</span><br><span class="line">        <span class="keyword">return</span> target[key]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 拦截写的操作</span></span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, newVal</span>) &#123;</span><br><span class="line">        <span class="comment">// 设置属性</span></span><br><span class="line">        target[key] = newVal</span><br><span class="line">        <span class="comment">// 从bucket中取出副作用函数并执行</span></span><br><span class="line">        bucket.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 副作用函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 读取了obj.text</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">text</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;After 2s....&#x27;</span>)</span><br><span class="line">    obj.<span class="property">text</span> = <span class="string">&#x27;hello wk&#x27;</span></span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure>

<p>这里定义了一个<code>data</code>对象，随后使用了<code>Proxy</code>对其进行了代理。在这个简单的响应式系统中，<code>Proxy</code>代理做了两件事：1）拦截读取操作，当副作用函数<code>effect</code>读取<code>obj.text</code>属性时，将副作用函数<code>effect</code>添加到<code>bucket</code>。2）拦截写操作，当重写<code>obj.text</code>属性时，从<code>bucket</code>中取出<code>effect</code>并执行。</p>
<p>运行上述代码：</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220716203916335.png" alt="image-20220716203916335"></p>
<p>了解了实现响应式系统最基本的原理后，我们在这个基础上一步一步的完善，让该响应式看起来“牛逼”一些。</p>
<h2 id="1-告别硬编码"><a href="#1-告别硬编码" class="headerlink" title="1 告别硬编码"></a>1 告别硬编码</h2><p>上述代码中，硬编码了副作用函数<code>effect</code>，而在实际的使用场景中，副作用可以是各种各样的名字，甚至是一个匿名函数，因此本节实现<strong>注册副作用函数的机制</strong>。</p>
<ul>
<li>提供注册副作用函数的入口</li>
<li>建立副作用函数与被操作目标字段之间的依赖关系</li>
</ul>
<p>提供注册副作用函数的入口：其实就是提供一个函数，可以将副作用函数作为参数传递给它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bucket = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"><span class="comment">// 全局变量，存储被注册的副作用函数</span></span><br><span class="line"><span class="keyword">let</span> activeEffect</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册副作用函数的入口</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="comment">// 当调用effect注册副作用函数时，将副作用函数fn赋值给activeEffect</span></span><br><span class="line">    activeEffect = fn</span><br><span class="line">    <span class="title function_">fn</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(activeEffect) &#123;</span><br><span class="line">            bucket.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target[key]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, newVal</span>) &#123;</span><br><span class="line">        target[key] = newVal</span><br><span class="line">        bucket.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>测试上述代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test</span></span><br><span class="line"><span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">text</span>)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;After 2s....&#x27;</span>)</span><br><span class="line">    obj.<span class="property">text</span> = <span class="string">&#x27;hello wk&#x27;</span></span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;After 3s....&#x27;</span>)</span><br><span class="line">    obj.<span class="property">noExit</span> = <span class="string">&#x27;hello wk&#x27;</span></span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220716211208321.png" alt="image-20220716211208058"></p>
<p>第一次的输出在预期之内，当<code>obj.text</code>属性被修改时，能够执行在<code>effect</code>中注册的匿名函数。但第二次的输出与预期不符合，因为在第二个<code>setTimeout</code>中没有修改<code>obj.text</code>属性，而是为<code>obj</code>提供一个新的属性<code>noExit</code>。按照正常的逻辑思维，该<strong>匿名函数</strong>在注册时<code>Proxy</code>拦截的<code>key</code>值为<code>text</code>，也就是该<strong>匿名函数</strong>是作为<code>obj.text</code>属性的<strong>副作用函数</strong>绑定在一起，所以我们不希望在<code>Proxy</code>拦截<strong>其它属性的写操作</strong>（<code>noExit</code>）时会触发该副作用函数。</p>
<p>解决这个问题很简单，在注册阶段建立起<strong>对象属性</strong>和<strong>副作用函数</strong>对应的关系即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 替换set的数据结构，使用WeakMap</span></span><br><span class="line"><span class="keyword">const</span> bucket = <span class="keyword">new</span> <span class="title class_">WeakMap</span>()</span><br><span class="line"><span class="keyword">let</span> activeEffect</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    activeEffect = fn</span><br><span class="line">    <span class="title function_">fn</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="title function_">track</span>(target, key)</span><br><span class="line">        <span class="keyword">return</span> target[key]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, newVal</span>) &#123;</span><br><span class="line">        target[key] = newVal</span><br><span class="line">        <span class="title function_">trigger</span>(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将拦截读取的操作提取出来</span></span><br><span class="line"><span class="comment">// 作用：将副作用函数activeEffect函数添加到bucket中</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!activeEffect) <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// 取出对象（target）的Map</span></span><br><span class="line">    <span class="keyword">let</span> depsMap = bucket.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="comment">// 如果不存在，那么新建立一个Map，并建立与target的联系</span></span><br><span class="line">    <span class="keyword">if</span>(!depsMap) &#123;</span><br><span class="line">        bucket.<span class="title function_">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取出属性（key）的set</span></span><br><span class="line">    <span class="keyword">let</span> deps = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">    <span class="comment">// 如果不存在，建立一个新的set，并建立与key的关系</span></span><br><span class="line">    <span class="keyword">if</span>(!deps) &#123;</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, (deps = <span class="keyword">new</span> <span class="title class_">Set</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将当前全局变量中的副作用函数添加到“对象-属性-set”层面的依赖中</span></span><br><span class="line">    deps.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将拦截写的操作提取出来</span></span><br><span class="line"><span class="comment">// 作用：从bucket中取出副作用函数并执行</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="comment">// 取出对象（target）层级的依赖关系</span></span><br><span class="line">    <span class="keyword">const</span> depsMap = bucket.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap) <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// 取出属性（key）层级的依赖关系</span></span><br><span class="line">    <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">    <span class="comment">// 执行副作用函数</span></span><br><span class="line">    effects &amp;&amp; effects.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里做了两点变动：</p>
<p>1）逻辑上的变动</p>
<p>首先是逻辑上的变动，在<code>bucket</code>的数据结构上，使用了<code>WeakMap</code>代替了<code>set</code>结构。<code>Map</code>数据结构比<code>Set</code>数据结构能更好的建立起一一对应的依赖关系，这里选用了<code>WeakMap</code>而没有<code>Map</code>，是因为<code>WeakMap</code>对<code>key</code>是弱引用，不会影响垃圾回收的工作。简单来说，就是当作为<code>WeakMap</code>的<code>key</code>键存在的对象一旦没有任何引用了，就会被js引擎自动回收，后面也无法通过该<code>key</code>键对应的值。</p>
<p>改变了存储副作用函数的<code>bucket</code>的数据结构后，相应的<strong>读拦截操作</strong>逻辑也进行改变，让其从级别1的捕获，细化为级别2的捕获。细化后的<strong>读拦截操作</strong>能够精准的建立起<strong>某个对象的某个属性</strong>和<strong>副作用函数</strong>的依赖关系。在<strong>拦截写操作</strong>时，根据读阶段拦截的层级关系，找出对应属性的所以副作用函数，并依次执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">级别1：bucket（set）- 对象（key）- 副作用函数（value）</span><br><span class="line">级别2：bucket（weakmap）-对象（key）- 属性Map（value） =&gt;  属性Map（map）- 属性（key）- 副作用函数集合set（value）</span><br></pre></td></tr></table></figure>

<p>2）代码层面的封装</p>
<p>将<code>Proxy</code>中拦截操作的相关逻辑提炼出来，得到了<code>track</code>函数和<code>trigger</code>函数：<code>track</code>函数名有“追踪”的含义，负责将副作用函数<code>activeEffect</code>函数添加到<code>bucket</code>中；<code>trigger</code>意味触发机，在对象属性进行改动时，从<code>bucket</code>中取出相应的副作用函数并执行。</p>
<h2 id="2-完善依赖关系的建立——分支切换-amp-cleanup"><a href="#2-完善依赖关系的建立——分支切换-amp-cleanup" class="headerlink" title="2 完善依赖关系的建立——分支切换&amp;cleanup"></a>2 完善依赖关系的建立——分支切换&amp;cleanup</h2><p>在1中，我们对代码进行了两个方面的改动，其中花费了很大的力气重新建立了副作用函数和对应属性的依赖关系，但还是存在一些问题。看下述测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">ok</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">effectFn</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> out = obj.<span class="property">ok</span> ? obj.<span class="property">text</span> : <span class="string">&#x27;hello wk&#x27;</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(out)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">ok</span> = <span class="literal">false</span></span><br><span class="line">obj.<span class="property">text</span> = <span class="string">&#x27;hello my world&#x27;</span></span><br></pre></td></tr></table></figure>

<p>执行结果如下</p>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220716224627370.png" alt="image-20220716224627370"></p>
<p><code>obj.ok</code>值设置为<code>false</code>时，副作用函数触发了两次，这不是期望得到的结果。因为<code>obj.ok</code>值设置为<code>false</code>时，副作用函数<code>effectFn</code>不会读取<code>obj.text</code>，所以应该删除<code>obj.text</code>属性与副作用函数<code>effectFn</code>之间的依赖关系。</p>
<ul>
<li>给副作用函数新增<code>deps</code>数组，存储所有与副作用函数建立依赖关系的对象属性的<code>set</code></li>
<li><code>deps</code>的收集放在<code>track</code>中</li>
<li><code>trigger</code>函数需要重新建立<code>effectsToRun</code>，避免无线循环执行。<ul>
<li>如果不修改，副作用函数每次会调用<code>cleanup</code>清除<code>deps</code>中的相关依赖</li>
<li>执行<code>fn</code>时，又会将依赖添加入<code>deps</code>中</li>
<li>循环上面两个步骤，就会无限执行</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">effectFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>(effectFn)</span><br><span class="line">        activeEffect = effectFn</span><br><span class="line">        <span class="title function_">fn</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 为副作用函数新增依赖收集的入口</span></span><br><span class="line">    effectFn.<span class="property">deps</span> = []</span><br><span class="line">    <span class="title function_">effectFn</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除所有与副作用函数建立依赖关系的对象属性set中的该副作用函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanup</span>(<span class="params">effectFn</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; effectFn.<span class="property">deps</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deps = effectFn.<span class="property">deps</span>[i]</span><br><span class="line">        deps.<span class="title function_">delete</span>(effectFn)</span><br><span class="line">    &#125;</span><br><span class="line">    effectFn.<span class="property">deps</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!activeEffect) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">let</span> depsMap = bucket.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap) &#123;</span><br><span class="line">        bucket.<span class="title function_">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> deps = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">    <span class="keyword">if</span>(!deps) &#123;</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, (deps = <span class="keyword">new</span> <span class="title class_">Set</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">    deps.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">	<span class="comment">// 副作用函数收集依赖的过程</span></span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(deps)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> depsMap = bucket.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">	<span class="comment">// 避免无线循环</span></span><br><span class="line">    <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects)</span><br><span class="line">    effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effectFn</span> =&gt;</span> <span class="title function_">effectFn</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-完善依赖关系的建立——effect嵌套"><a href="#3-完善依赖关系的建立——effect嵌套" class="headerlink" title="3 完善依赖关系的建立——effect嵌套"></a>3 完善依赖关系的建立——effect嵌套</h2><p>副作用函数可以进行嵌套</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">bar</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(<span class="keyword">function</span> <span class="title function_">effectFn1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effectFn1执行&#x27;</span>)</span><br><span class="line">    <span class="title function_">effect</span>(<span class="keyword">function</span> <span class="title function_">effectFn2</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effectFn2执行&#x27;</span>)</span><br><span class="line">        <span class="keyword">const</span> b = obj.<span class="property">bar</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> a = obj.<span class="property">foo</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">obj.<span class="property">foo</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>在嵌套发生的情况下，期望建立的依赖如下：</p>
<ul>
<li><code>obj.foo</code>修改触发<code>effectFn1</code>，而<code>effectFn1</code>又间接触发<code>effectFn2</code></li>
<li><code>obj.bar</code>修改触发<code>effectFn2</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/wk-Nemo/imgBed/main/imgimage-20220717132816916.png" alt="image-20220717132816916"></p>
<p>但实际代码的运行结果如上，当<code>obj.foo</code>修改时，不但没有触发<code>effectFn1</code>反而触发了<code>effectFn2</code>。这是因为当<code>effectFn2</code>结束运行后，<code>obj.foo</code>的读操作拦截<code>track</code>在收集依赖的过程中，将全局变量<code>activeEffect</code>（此时为<code>effectFn2</code>）添加到了对应的属性的副作用函数依赖中。因此，在副作用函数发生嵌套时，<strong>需要一个函数栈<code>effectStack</code>，在副作用函数执行时将其压入栈底，待副作用函数执行结束时再将其从栈中弹出，并始终让<code>activeEffect</code>指向栈顶的副作用函数</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect</span><br><span class="line"><span class="comment">// effect栈 预防副作用函数嵌套</span></span><br><span class="line"><span class="keyword">const</span> effectStack = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">effectFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>(effectFn)</span><br><span class="line">        activeEffect = effectFn</span><br><span class="line">        <span class="comment">// 副作用函数调用之前入栈</span></span><br><span class="line">        effectStack.<span class="title function_">push</span>(effectFn)</span><br><span class="line">        <span class="title function_">fn</span>()</span><br><span class="line">        <span class="comment">// 副作用函数调用完出栈</span></span><br><span class="line">        effectStack.<span class="title function_">pop</span>()</span><br><span class="line">        <span class="comment">// 激活的副作用函数始终指向栈顶</span></span><br><span class="line">        activeEffect = effectStack[effectStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    effectFn.<span class="property">deps</span> = []</span><br><span class="line">    <span class="title function_">effectFn</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-完善依赖关系的建立——避免无限递归循环"><a href="#4-完善依赖关系的建立——避免无限递归循环" class="headerlink" title="4 完善依赖关系的建立——避免无限递归循环"></a>4 完善依赖关系的建立——避免无限递归循环</h2><p>继续完善依赖关系的建立：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;...&#125;)</span><br><span class="line">                       </span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	obj.<span class="property">foo</span> = obj.<span class="property">foo</span> + <span class="number">1</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上述的副作用函数会造成无限循环：</p>
<ul>
<li>副作用函数读取<code>obj.foo</code>，触发<code>track</code>，建立两者的依赖关系</li>
<li>副作用函数给<code>obj.foo</code>赋值+1后的数字，触发<code>trigger</code>，继续执行副作用函数</li>
<li>上面两个步骤一直循环下去，会造成栈溢出</li>
</ul>
<p>可以给<code>trigger</code>增加<strong>守卫条件</strong>：如果<code>trigger</code>触发的副作用函数与当前激活的副作用函数<code>activeEffect</code>相同，则不触发</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> depsMap = bucket.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    effects &amp;&amp; effects.<span class="title function_">forEach</span>(<span class="function"><span class="params">effectFn</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 避免无限循环</span></span><br><span class="line">        <span class="keyword">if</span>(effectFn !== activeEffect) &#123;</span><br><span class="line">            effectsToRun.<span class="title function_">add</span>(effectFn)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effectFn</span> =&gt;</span> <span class="title function_">effectFn</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E7%99%BD%E5%AB%96%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/24/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E7%99%BD%E5%AB%96%E7%AF%87/" class="post-title-link" itemprop="url">前端性能优化——白嫖篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-24 21:53:09" itemprop="dateCreated datePublished" datetime="2022-03-24T21:53:09+08:00">2022-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:41:47" itemprop="dateModified" datetime="2023-05-07T17:41:47+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">性能优化</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近打算了解性能优化，看到一篇不错的文章，白嫖一下：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6974565176427151397">前端性能优化指标 + 检测工具</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E8%B7%9F%E7%9D%80%E3%80%8AVue.js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B%E5%AD%A6%E4%B9%A0Vue3%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/24/%E8%B7%9F%E7%9D%80%E3%80%8AVue.js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B%E5%AD%A6%E4%B9%A0Vue3%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">跟着《Vue.js设计与实现》学习Vue3模板编译</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-24 21:19:29" itemprop="dateCreated datePublished" datetime="2022-03-24T21:19:29+08:00">2022-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:40:28" itemprop="dateModified" datetime="2023-05-07T17:40:28+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-写在前面"><a href="#0-写在前面" class="headerlink" title="0 写在前面"></a>0 写在前面</h2><p>前段时间加入的前端讨论群和关注的一些公众号被《Vue.js设计与实现》刷屏，抱着好奇的心态买了一本回来学习。之前学习 Vue2 时就对模板编译这一块不是很理解，于是乎书到手就开始跟着书去学这一部分，并总结了这篇博客。有很多地方写的不是很详细，只是方便大家了解整体的流程，详细内容还是强烈推荐大家去看原著。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a5b8f5465bb45fb86ebdbdaf2423e01~tplv-k3u1fbpfcp-watermark.image" alt="CD2FBF3CCBF00D968BB051266B38C06C.jpg"></p>
<h2 id="1-虚拟DOM"><a href="#1-虚拟DOM" class="headerlink" title="1 虚拟DOM"></a>1 虚拟DOM</h2><p>Vue为我们提供了<strong>模版语法</strong>，我们可以通过编写如下的代码获取我们想要的 dom 结构</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span> @<span class="attr">click</span>=<span class="string">&quot;handler&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这并不是真实的 HTML 语句，因为模板语法里面我们可以使用 <code>v-if</code>、<code>v-for</code>、<code>v-on</code>等指令，模板里的语法最终会被转换成虚拟 DOM 描述的 UI。如果你比较熟悉虚拟 DOM，你可以不使用模板，直接写<strong>渲染（render）函数</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;h&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;h1&#x27;</span>, &#123; <span class="attr">onClick</span>: handler &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <strong>h 函数</strong>是为了帮助我们编写虚拟 DOM 更加的轻松，其最终返回的内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">tag</span>: <span class="string">&#x27;h1&#x27;</span>,</span><br><span class="line">      <span class="attr">props</span>: &#123; <span class="attr">onClick</span>: handler &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个组件要渲染的内容是通过<strong>渲染函数</strong>来描述的，也就是上述代码的 <strong>render 函数</strong>。Vue 会根据组件的 render 函数返回值拿到虚拟 DOM ，然后再经过<strong>渲染器</strong>的渲染，就可以把<strong>虚拟 DOM</strong> 渲染成<strong>真实的 DOM</strong>。</p>
<h2 id="2-模板编译"><a href="#2-模板编译" class="headerlink" title="2 模板编译"></a>2 模板编译</h2><p>上面我们讲了模板语法最终会被转换成渲染函数，渲染函数最终会返回成虚拟 DOM，以便后面的流程正常的进行。而模板语法转换成渲染函数便是<strong>编译器</strong>做的工作，对于如下的模板：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">&quot;handler&quot;</span>&gt;</span></span><br><span class="line">  click me</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>经过编译器的工作最终会转换成如下的渲染函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">onClick</span>: handler &#125;, <span class="string">&#x27;click me&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以我们熟悉的 .vue 文件为例，一个 .vue 文件就是一个组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div @click=&quot;handler&quot;&gt;</span><br><span class="line">    click me</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      // 数据...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;，</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handler: function() &#123;</span><br><span class="line">      // 函数体...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>&lt;template&gt;</code> 标签里的内容就是模板内容，编译器会把模板内容编译成渲染函数并添加到 <code>&lt;script&gt;</code> 标签块的组件对象上，最终代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 数据...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;，</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="attr">handler</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 函数体...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">onClick</span>: handler &#125;, <span class="string">&#x27;click me&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-传统编译器"><a href="#3-传统编译器" class="headerlink" title="3  传统编译器"></a>3  传统编译器</h2><p>编译器其实只是一段程序，它用于将 A 语言翻译成 B 语言。</p>
<ul>
<li>A 语言：源代码</li>
<li>B 语言： 目标代码</li>
<li>源代码 -&gt; 目标代码：编译</li>
</ul>
<p>完整的编译一般包含以下几个步骤</p>
<ul>
<li>词法分析</li>
<li>语法分析</li>
<li>语义分析</li>
<li>中间代码生成</li>
<li>优化</li>
<li>目标代码生成</li>
</ul>
<h2 id="4-Vue编译器概览"><a href="#4-Vue编译器概览" class="headerlink" title="4 Vue编译器概览"></a>4 Vue编译器概览</h2><p>Vue 的模板作为 DSL（涉及一种领域特定的语言），其编译流程会有所不同。对 Vue 来说，源代码就是组件模板，目标代码就是能在浏览器上运行的 js 代码，或者其他拥有 js 运行时的平台代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 源代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">:id</span>=<span class="string">&quot;dynamicId&quot;</span>&gt;</span></span><br><span class="line">    Vue Template</span><br><span class="line">  <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, [</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;h1&#x27;</span>, &#123;<span class="attr">id</span>: dynamic&#125;, <span class="string">&#x27;Vue Template&#x27;</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Vue 的模板编译器首先对模板进行<strong>词法分析</strong>和<strong>语法分析</strong>，得到<strong>模板 AST</strong>。接着，将<strong>模板 AST</strong> 转换成 <strong>JavaScriptAST</strong>。最后，根据 <strong>JavaScriptAST</strong> 生成 <strong>JavaScript 代码</strong>（即渲染函数代码），具体流程如下：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44e9c0f5e84244ed848ba1a79fea17ae~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>总的来说Vue编译的核心<strong>主要是三个阶段</strong>：parse、transform、generate。Vue 核心 compiler 的代码只是简单的调用了这三个函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compiler</span>(<span class="params">template</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template)</span><br><span class="line">  <span class="title function_">transform</span>(ast)</span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast.<span class="property">jsNode</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第一步 parse：</strong> 这里将<strong>模板</strong>转换成<strong>模板AST</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0415701b0ea848318924490a81dce9cc~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tokens</span></span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;tag&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;div&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;tag&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;text&#x27;</span>, <span class="attr">context</span>: <span class="string">&#x27;Vue&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;tagEnd&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;tag&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;text&#x27;</span>, <span class="attr">context</span>: <span class="string">&#x27;Template&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;tagEnd&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: <span class="string">&#x27;tagEnd&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;div&#x27;</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模版AST</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;Root&#x27;</span>,</span><br><span class="line">  <span class="attr">childrent</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">      <span class="attr">tag</span>: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">          <span class="attr">tag</span>: <span class="string">&#x27;p&#x27;</span></span><br><span class="line">          <span class="attr">children</span>: [&#123; <span class="attr">type</span>: <span class="string">&#x27;Text&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;Vue&#x27;</span> &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">          <span class="attr">tag</span>: <span class="string">&#x27;p&#x27;</span></span><br><span class="line">          <span class="attr">children</span>: [&#123; <span class="attr">type</span>: <span class="string">&#x27;Text&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;Template&#x27;</span> &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第二步 transform：</strong> 这里为第一步生成的<strong>模板AST</strong>中树的每一个节点添加一个 <strong>jsNode</strong>，也就是 <strong>JavaScriptAST</strong></p>
<p>这里我们为什么不直接将模板AST转换成目标代码呢？</p>
<p>因为我们需要将模板AST编译成渲染函数，而渲染函数是由 JavaScript 代码来描述的，因此，我们需要将<strong>模板AST</strong>转换成用于<strong>描述渲染函数的AST</strong>，即 <strong>JavaScriptAST</strong>。下面举个例子更清楚的去了解这句话的意思：</p>
<p><code>&lt;div&gt;&lt;p&gt;Vue&lt;/p&gt;&lt;p&gt;Template&lt;/p&gt;&lt;/div&gt;</code>模板最终返回的渲染函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, [</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;Vue&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;Template&#x27;</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 transform 要做的工作就是将第一步中的模板AST转换成如下用于描述渲染函数的数据结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">FunctionDeclNode</span> = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;FunctionDecl&#x27;</span>, <span class="comment">// 节点类型</span></span><br><span class="line">    <span class="comment">// 函数名称</span></span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;render&#x27;</span>&#125;,</span><br><span class="line">    <span class="comment">// 函数参数</span></span><br><span class="line">    <span class="attr">params</span>: [],</span><br><span class="line">    <span class="comment">// 函数体</span></span><br><span class="line">    <span class="attr">body</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;ReturnStatement&#x27;</span>,</span><br><span class="line">            <span class="attr">return</span>: &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                <span class="attr">callee</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Indentifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;h&#x27;</span> &#125;,</span><br><span class="line">                <span class="attr">arguments</span>: [</span><br><span class="line">                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;div&#x27;</span> &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;ArrayExpression&#x27;</span>,</span><br><span class="line">                        <span class="attr">elements</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                                <span class="attr">callee</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Indentifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;h&#x27;</span> &#125;,</span><br><span class="line">                                <span class="attr">arguments</span>: [</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;Vue&#x27;</span>&#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                                <span class="attr">callee</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Indentifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;h&#x27;</span> &#125;,</span><br><span class="line">                                <span class="attr">arguments</span>: [</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;Template&#x27;</span> &#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第三步 generate：</strong> 在第二步中我们获取了描述渲染函数的 ast，这一步中我们根据该 ast 进行字符串的拼接得倒渲染函数据即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, [</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;Vue&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;Template&#x27;</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-parse详解"><a href="#5-parse详解" class="headerlink" title="5 parse详解"></a>5 parse详解</h2><p>上面我们了解了 parse 的主要的工作是读取 Vue 的模板代码，然后将他们解析成一个一个 Token，最后再根据这些 Token 生成模板AST。</p>
<p>首先了解解析成 Token 的规则，这里用到了<strong>有限状态机</strong>。学过编译的同学肯定对这个词不陌生，简单介绍一下，解析器在解析模板时会遇到 n 种的状态，每个状态下遇到不同情况要跳转到哪一种情况。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 状态机状态</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">State</span> = &#123;</span><br><span class="line">    <span class="attr">initial</span>: <span class="number">1</span>,      <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="attr">tagOpen</span>: <span class="number">2</span>,      <span class="comment">// 标签开始状态</span></span><br><span class="line">    <span class="attr">tagName</span>: <span class="number">3</span>,      <span class="comment">// 标签名称状态</span></span><br><span class="line">    <span class="attr">text</span>: <span class="number">4</span>,         <span class="comment">// 文本状态</span></span><br><span class="line">    <span class="attr">tagEnd</span>: <span class="number">5</span>,       <span class="comment">// 结束标签状态</span></span><br><span class="line">    <span class="attr">tagEndName</span>: <span class="number">6</span>    <span class="comment">// 结束标签名称状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是字母</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isAlpha</span>(<span class="params">char</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> char &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; char &lt;= <span class="string">&#x27;z&#x27;</span> || char &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; char&lt;= <span class="string">&#x27;Z&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tokenSize</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="comment">//一开始是初始状态</span></span><br><span class="line">    <span class="keyword">let</span> currentState = <span class="title class_">State</span>.<span class="property">initial</span></span><br><span class="line">    <span class="keyword">const</span> chars = []</span><br><span class="line">    <span class="keyword">const</span> tokens = []</span><br><span class="line">    <span class="comment">// 状态机不断循环，当全部解析完毕后循环停止</span></span><br><span class="line">    <span class="keyword">while</span>(str) &#123;</span><br><span class="line">        <span class="keyword">const</span> char = str[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">switch</span>(currentState) &#123;</span><br><span class="line">            <span class="comment">// 初始状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">State</span>.<span class="property">initial</span>:</span><br><span class="line">                <span class="keyword">if</span>(char === <span class="string">&#x27;&lt;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 遇到 &lt; 进入标签开始状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">tagOpen</span></span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title function_">isAlpha</span>(char)) &#123;</span><br><span class="line">                    <span class="comment">// 遇到字母进入文本状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">text</span></span><br><span class="line">                    chars.<span class="title function_">push</span>(char)</span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">// 标签开始状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">State</span>.<span class="property">tagOpen</span>:</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_">isAlpha</span>(char)) &#123;</span><br><span class="line">                    <span class="comment">// 遇到字母进入标签名称状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">tagName</span></span><br><span class="line">                    chars.<span class="title function_">push</span>(char)</span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 遇到 / 进入结束标签状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">tagEnd</span></span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">// 标签名称状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">State</span>.<span class="property">tagName</span>:</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_">isAlpha</span>(char)) &#123;</span><br><span class="line">                    <span class="comment">// 遇到字母，任然处于标签名称状态</span></span><br><span class="line">                    chars.<span class="title function_">push</span>(char)</span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 遇到 &gt; 进入初始状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">initial</span></span><br><span class="line">                    <span class="comment">// 解析成功一个 tag</span></span><br><span class="line">                    tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;tag&#x27;</span>,</span><br><span class="line">                        <span class="attr">name</span>: chars.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    chars.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">// 文本状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">State</span>.<span class="property">text</span>:</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isAlpha</span>(char)) &#123;</span><br><span class="line">                    <span class="comment">// 遇到字母任然保持文本状态</span></span><br><span class="line">                    chars.<span class="title function_">push</span>(char)</span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">&#x27;&lt;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 遇到 &lt; 进入标签开始状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">tagOpen</span></span><br><span class="line">                    <span class="comment">// 解析成功一个 text</span></span><br><span class="line">                    tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">                        <span class="attr">content</span>: chars.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    chars.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">// 结束标签状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">State</span>.<span class="property">tagEnd</span>:</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_">isAlpha</span>(char)) &#123;</span><br><span class="line">                    <span class="comment">// 遇到字母进入结束标签名称状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">tagEndName</span></span><br><span class="line">                    chars.<span class="title function_">push</span>(char)</span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">// 结束标签名称状态</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">State</span>.<span class="property">tagEndName</span>:</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_">isAlpha</span>(char)) &#123;</span><br><span class="line">                    <span class="comment">// 遇到字母保持结束标签名称状态</span></span><br><span class="line">                    chars.<span class="title function_">push</span>(char)</span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(char === <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 遇到 &gt; 进入初始状态</span></span><br><span class="line">                    currentState = <span class="title class_">State</span>.<span class="property">initial</span></span><br><span class="line">                    <span class="comment">// 成功解析 tagEnd</span></span><br><span class="line">                    tokens.<span class="title function_">push</span>(&#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;tagEnd&#x27;</span>,</span><br><span class="line">                        <span class="attr">name</span>: chars.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    chars.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">                    str = str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tokens</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = <span class="string">&#x27;&lt;div&gt;&lt;p&gt;Vue&lt;/p&gt;&lt;p&gt;Template&lt;/p&gt;&lt;/div&gt;&#x27;</span></span><br><span class="line"><span class="keyword">const</span> tokens = <span class="title function_">tokenSize</span>(template)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(tokens)</span><br></pre></td></tr></table></figure>

<p>执行上述代码，最后 <code>&lt;div&gt;&lt;p&gt;Vue&lt;/p&gt;&lt;p&gt;Template&lt;/p&gt;&lt;/div&gt;</code> 被解析成 tokens，如下：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bc2521530e3439c9f535656b99efc2d~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>拿到上面的 tokens 后，我们要将其转换成模板AST。思路比较简单，用一个栈进行存储，首先推入根结点 root，接着遍历一遍 tokens，根据不同的情况进行进栈和出栈的操作即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tokenSize &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./token&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取 tokens</span></span><br><span class="line">    <span class="keyword">const</span> tokens = <span class="title function_">tokenSize</span>(str)</span><br><span class="line">    <span class="comment">// 根结点</span></span><br><span class="line">    <span class="keyword">const</span> root = &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Root&#x27;</span>,</span><br><span class="line">        <span class="attr">children</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 栈</span></span><br><span class="line">    <span class="keyword">const</span> elementStack = [root]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(tokens.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> parent = elementStack[elementStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">const</span> t = tokens[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">switch</span>(t.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;tag&#x27;</span>:</span><br><span class="line">                <span class="keyword">const</span> elementNode = &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">                    <span class="attr">tag</span>: t.<span class="property">name</span>,</span><br><span class="line">                    <span class="attr">children</span>: []</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加到父节点的children属性中</span></span><br><span class="line">                parent.<span class="property">children</span>.<span class="title function_">push</span>(elementNode)</span><br><span class="line">                <span class="comment">// 加入栈顶</span></span><br><span class="line">                elementStack.<span class="title function_">push</span>(elementNode)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;text&#x27;</span>:</span><br><span class="line">                <span class="keyword">const</span> textNode = &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Text&#x27;</span>,</span><br><span class="line">                    <span class="attr">content</span>: t.<span class="property">content</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加到父节点的children属性中</span></span><br><span class="line">                parent.<span class="property">children</span>.<span class="title function_">push</span>(textNode)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;tagEnd&#x27;</span>:</span><br><span class="line">                <span class="comment">// 弹出栈顶</span></span><br><span class="line">                elementStack.<span class="title function_">pop</span>()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tokens.<span class="title function_">shift</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行上面的代码，最后 <code>&lt;div&gt;&lt;p&gt;Vue&lt;/p&gt;&lt;p&gt;Template&lt;/p&gt;&lt;/div&gt;</code> 被解析成模板AST如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;Root&#x27;</span>,</span><br><span class="line">  <span class="attr">childrent</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">      <span class="attr">tag</span>: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">          <span class="attr">tag</span>: <span class="string">&#x27;p&#x27;</span></span><br><span class="line">          <span class="attr">children</span>: [&#123; <span class="attr">type</span>: <span class="string">&#x27;Text&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;Vue&#x27;</span> &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;Element&#x27;</span>,</span><br><span class="line">          <span class="attr">tag</span>: <span class="string">&#x27;p&#x27;</span></span><br><span class="line">          <span class="attr">children</span>: [&#123; <span class="attr">type</span>: <span class="string">&#x27;Text&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;Template&#x27;</span> &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-transform-详解"><a href="#6-transform-详解" class="headerlink" title="6 transform 详解"></a>6 transform 详解</h2><p>上面我们提到了，为了生成最终的 render 函数，我们只拿到<strong>模板AST</strong>还不够，需要将用于<strong>描述模板的AST转换成用于描述JavaScript的AST</strong>。</p>
<p>我们最终要转换的目标如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, [</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;Vue&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;Template&#x27;</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码用如下 AST 来描述：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">FunctionDeclNode</span> = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;FunctionDecl&#x27;</span>, <span class="comment">// 节点类型</span></span><br><span class="line">    <span class="comment">// 函数名称</span></span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;render&#x27;</span>&#125;,</span><br><span class="line">    <span class="comment">// 函数参数</span></span><br><span class="line">    <span class="attr">params</span>: [],</span><br><span class="line">    <span class="comment">// 函数体</span></span><br><span class="line">    <span class="attr">body</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;ReturnStatement&#x27;</span>,</span><br><span class="line">            <span class="attr">return</span>: &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                <span class="attr">callee</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Indentifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;h&#x27;</span> &#125;,</span><br><span class="line">                <span class="attr">arguments</span>: [</span><br><span class="line">                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;div&#x27;</span> &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;ArrayExpression&#x27;</span>,</span><br><span class="line">                        <span class="attr">elements</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                                <span class="attr">callee</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Indentifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;h&#x27;</span> &#125;,</span><br><span class="line">                                <span class="attr">arguments</span>: [</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;Vue&#x27;</span>&#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">                                <span class="attr">callee</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Indentifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;h&#x27;</span> &#125;,</span><br><span class="line">                                <span class="attr">arguments</span>: [</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;p&#x27;</span> &#125;,</span><br><span class="line">                                    &#123; <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;Template&#x27;</span> &#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以现在的思路就是将第五步中拿到的AST转换成上述的AST。先定义一些辅助函数为实现这一步骤做一些铺垫。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 StringLiteral 类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createStringLiteral</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>,</span><br><span class="line">        value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 Identifier 类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createIdentifier</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">        name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 ArrayExpression 类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createArrayExpression</span>(<span class="params">elements</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;ArrayExpression&#x27;</span>,</span><br><span class="line">        elements</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 CallExpression 类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createCallExpression</span>(<span class="params">callee, <span class="variable language_">arguments</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">        <span class="attr">callee</span>: <span class="title function_">createIdentifier</span>(callee),</span><br><span class="line">        <span class="variable language_">arguments</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将模板AST中Text类型节点转换成JSAST中StringLiteral类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformText</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(node.<span class="property">type</span> !== <span class="string">&#x27;Text&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node.<span class="property">jsNode</span> = <span class="title function_">createStringLiteral</span>(node.<span class="property">content</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将模板AST中Element类型节点转换成JSAST中类型节点CallExpression类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformElement</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(node.<span class="property">type</span> !== <span class="string">&#x27;Element&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> callExp = <span class="title function_">createCallExpression</span>(<span class="string">&#x27;h&#x27;</span>, [</span><br><span class="line">            <span class="title function_">createStringLiteral</span>(node.<span class="property">tag</span>)</span><br><span class="line">        ])</span><br><span class="line">        node.<span class="property">children</span>.<span class="property">length</span> === <span class="number">1</span></span><br><span class="line">            ? callExp.<span class="property">arguments</span>.<span class="title function_">push</span>(node.<span class="property">children</span>[<span class="number">0</span>].<span class="property">jsNode</span>)</span><br><span class="line">            : callExp.<span class="property">arguments</span>.<span class="title function_">push</span>(</span><br><span class="line">                <span class="title function_">createArrayExpression</span>(node.<span class="property">children</span>.<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> c.<span class="property">jsNode</span>))</span><br><span class="line">            )</span><br><span class="line">        node.<span class="property">jsNode</span> = callExp</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将模板AST中Element类型节点转换成JSAST中类型节点FunctionDecl类型节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformRoot</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(node.<span class="property">type</span> !== <span class="string">&#x27;Root&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> vnodeJSAST = node.<span class="property">children</span>[<span class="number">0</span>].<span class="property">jsNode</span></span><br><span class="line">        node.<span class="property">jsNode</span> = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;FunctionDecl&#x27;</span>,</span><br><span class="line">            <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;render&#x27;</span> &#125;,</span><br><span class="line">            <span class="attr">params</span>: [],</span><br><span class="line">            <span class="attr">body</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;ReturnStatement&#x27;</span>,</span><br><span class="line">                    <span class="attr">return</span>: vnodeJSAST</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们考虑如下两点：</p>
<p><strong>问题一：</strong> AST是树形结构，所以想要将一种AST转换成另一种AST我们需要进行树的深度遍历，如何在遍历的过程中对其中的节点进行修改、删除和替换等操作？</p>
<p>我们可以定义一个 context 上下文，用于存储当前的节点，父节点，以及需要操作的函数。在遍历的开始让节点执行每一个函数。</p>
<p><strong>问题二：</strong> 在转换AST的过程中，往往需要根据子节点的情况来判断对当前节点进行替换，这就要求父节点转换操作必须等待所有子节点转换完毕以后再执行。这点如何去做？</p>
<p>在上述遍历过程中，定义一个数组用于存储函数，在遍历的最后再去执行这些函数</p>
<p>解决了上面两个问题我们上代码，我们在深度遍历的过程中，使用上面定义的辅助函数，实现了AST的转换，得到了本小结开始处所想要的 <code>FunctionDeclNode</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">transform</span>(<span class="params">ast</span>) &#123;</span><br><span class="line">    <span class="title function_">dump</span>(ast)</span><br><span class="line">    <span class="keyword">const</span> context = &#123;</span><br><span class="line">        <span class="attr">currentNode</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">childIndex</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">parent</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">nodeTransforms</span>: [</span><br><span class="line">            transformRoot,</span><br><span class="line">            transformElement,</span><br><span class="line">            transformText</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">traverseNode</span>(ast, context)</span><br><span class="line">    <span class="title function_">dump</span>(ast)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 深度遍历模板AST</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traverseNode</span>(<span class="params">ast, context</span>) &#123;</span><br><span class="line">    <span class="comment">// 定义初始节点</span></span><br><span class="line">    context.<span class="property">currentNode</span> = ast</span><br><span class="line">    <span class="comment">// 存储函数的数组</span></span><br><span class="line">    <span class="keyword">const</span> exitFns = []</span><br><span class="line">    <span class="comment">// 上下文中的函数</span></span><br><span class="line">    <span class="keyword">const</span> transforms = context.<span class="property">nodeTransforms</span></span><br><span class="line">    <span class="comment">// 依次将函数存入exitFns中</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; transforms.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> onExit = transforms[i](context.<span class="property">currentNode</span>, context)</span><br><span class="line">        <span class="keyword">if</span>(onExit) &#123;</span><br><span class="line">            exitFns.<span class="title function_">push</span>(onExit)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!context.<span class="property">currentNode</span>) <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否有子节点</span></span><br><span class="line">    <span class="keyword">const</span> children = context.<span class="property">currentNode</span>.<span class="property">children</span></span><br><span class="line">    <span class="keyword">if</span>(children) &#123;</span><br><span class="line">        <span class="comment">// 深度遍历</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            context.<span class="property">parent</span> = context.<span class="property">currentNode</span></span><br><span class="line">            context.<span class="property">childIndex</span> = i</span><br><span class="line">            <span class="title function_">traverseNode</span>(children[i], context)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行函数</span></span><br><span class="line">    <span class="keyword">let</span> i = exitFns.<span class="property">length</span></span><br><span class="line">    <span class="keyword">while</span>(i--) &#123;</span><br><span class="line">        exitFns[i]()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-generate-详解"><a href="#7-generate-详解" class="headerlink" title="7 generate 详解"></a>7 generate 详解</h2><p>有了 JavaScriptAST，接下来就是<strong>字符串拼接的艺术</strong>了。我们需要根据 JavaScriptAST 来生成最终的 render 函数，Vue 会根据组件的 render 函数返回值拿到虚拟 DOM ，然后再经过渲染器的渲染，就可以把虚拟 DOM 渲染成真实的 DOM。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compile</span>(<span class="params">template</span>) &#123;</span><br><span class="line">    <span class="comment">// 生成模板AST</span></span><br><span class="line">    <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template)</span><br><span class="line">    <span class="comment">// 转换成JavaScriptAST</span></span><br><span class="line">    <span class="title function_">transform</span>(ast)</span><br><span class="line">    <span class="comment">// 生成渲染函数</span></span><br><span class="line">    <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast.<span class="property">jsNode</span>)</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然这是后话了，在模板编译的模块中，我们只需要关注<strong>如何根据 JavaScriptAST 拼接成最后的 render 函数。</strong></p>
<p>因为要生成函数的描述，我们先定义一些要用到的辅助函数在一个上下文环境 context 中，context 中的 code 就是我们最终需要的 render 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">generate</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> context = &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="title function_">push</span>(<span class="params">code</span>) &#123;</span><br><span class="line">            context.<span class="property">code</span> += code</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">currentIndent</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="title function_">newline</span>(<span class="params"></span>) &#123;</span><br><span class="line">            context.<span class="property">code</span> += <span class="string">&#x27;\n&#x27;</span> + <span class="string">`  `</span>.<span class="title function_">repeat</span>(context.<span class="property">currentIndent</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">indent</span>(<span class="params"></span>) &#123;</span><br><span class="line">            context.<span class="property">currentIndent</span>++</span><br><span class="line">            context.<span class="title function_">newline</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">deIndent</span>(<span class="params"></span>) &#123;</span><br><span class="line">            context.<span class="property">currentIndent</span>--</span><br><span class="line">            context.<span class="title function_">newline</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">genNode</span>(node, context)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> context.<span class="property">code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>genNode 的逻辑很简单，根据节点的不同类型执行不同的函数，这里的 node 就是转换而来的 JavaScriptAST。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genNode</span>(<span class="params">node, context</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span>(node.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;FunctionDecl&#x27;</span>:</span><br><span class="line">            <span class="title function_">genFunctionDecl</span>(node, context)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;ReturnStatement&#x27;</span>:</span><br><span class="line">            <span class="title function_">genReturnStatement</span>(node, context)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;CallExpression&#x27;</span>:</span><br><span class="line">            <span class="title function_">genCallExpression</span>(node, context)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;StringLiteral&#x27;</span>:</span><br><span class="line">            <span class="title function_">genStringLiteral</span>(node, context)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;ArrayExpression&#x27;</span>:</span><br><span class="line">            <span class="title function_">genArrayExpression</span>(node, context)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点类型为 FunctionDecl，需要生成 <code>function(...) &#123; ... &#125;</code>。</p>
<ul>
<li>参数部分需要调用 genNode，最终走到 ArrayExpression 类型的判断。这里我们参数为空，因此不执行。</li>
<li>函数体内容需要调用 genNode 将 FunctionDecl 内部的 body 数组中的对象依次执行一遍。这里我们的对象只有一个 ReturnStatement 类型的节点，看下一步</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genFunctionDecl</span>(<span class="params">node, context</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; push, indent, deIndent &#125; = context</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`function <span class="subst">$&#123;node.id.name&#125;</span>`</span>)</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`(`</span>)</span><br><span class="line">    <span class="comment">// 为函数的参数生成代码</span></span><br><span class="line">    <span class="title function_">genNodeList</span>(node.<span class="property">params</span>, context)</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`) `</span>)</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">&#x27;&#123;&#x27;</span>)</span><br><span class="line">    <span class="title function_">indent</span>()</span><br><span class="line">    node.<span class="property">body</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">n</span> =&gt;</span> <span class="title function_">genNode</span>(n, context))</span><br><span class="line">    <span class="title function_">deIndent</span>()</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`&#125;`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点类型为 ReturnStatement，生成 <code>return ...</code></p>
<ul>
<li>return 后面的内容调用 genNode 生成。这里我们 node.return 的类型是 CallExpression</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genReturnStatement</span>(<span class="params">node, context</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; push &#125; = context</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`return `</span>)</span><br><span class="line">    <span class="title function_">genNode</span>(node.<span class="property">return</span>, context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点类型为 CallExpression，生成<code>funName(...)</code>，我们的 funName 为 h，因此最终生成的就是<code>h(...)</code>，函数调用的参数再次通过调用 genNode 生成。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genCallExpression</span>(<span class="params">node, context</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; push &#125; = context</span><br><span class="line">    <span class="keyword">const</span> &#123; callee, <span class="attr">arguments</span>: args &#125; = node</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;callee.name&#125;</span>(`</span>)</span><br><span class="line">    <span class="title function_">genNodeList</span>(args, context)</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`)`</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点类型为 StringLiteral，将对应的 value 值加到 code 上即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genStringLiteral</span>(<span class="params">node, context</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; push &#125; = context</span><br><span class="line">    <span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;node.value&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/23/js%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E2%80%94%E2%80%94%E9%80%BB%E8%BE%91%E6%AD%A3%E7%A1%AE%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/23/js%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E2%80%94%E2%80%94%E9%80%BB%E8%BE%91%E6%AD%A3%E7%A1%AE%E6%80%A7/" class="post-title-link" itemprop="url">js代码质量——逻辑正确性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-23 13:40:38" itemprop="dateCreated datePublished" datetime="2022-03-23T13:40:38+08:00">2022-03-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:48:23" itemprop="dateModified" datetime="2023-05-07T17:48:23+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>对于初入职场的我们，最重要的就是学习如何写出高质量的 js 代码。学习的途径也很简单，多看，多写，多总结：</p>
<ul>
<li>多看：看大佬们写的代码，学习他们智慧的结晶</li>
<li>多写：纸上得来终觉浅，不停的敲代码才能发现自己的问题，提升自己</li>
<li>多总结：我一直以来奉行的学习方法有两种——<strong>问题驱动学习</strong>和<strong>输出倒闭输入</strong>。只有自己认真的思考总结过，才能发现很多问题的细节，真正的去掌握知识。</li>
</ul>
<p>当然，<strong>我也是一个初入前端的小菜鸡</strong>，本篇博客有内容或认知上的错误属于正常现象，希望各位观众老爷们不吝赐教。本篇博客也不是一次就完成，后面每次小猪遇到新的问题都会跟进博客，当然也欢迎大家来评论区补充！</p>
<h2 id="0-什么是逻辑正确性？"><a href="#0-什么是逻辑正确性？" class="headerlink" title="0 什么是逻辑正确性？"></a>0 什么是逻辑正确性？</h2><h2 id="1-三元表达式"><a href="#1-三元表达式" class="headerlink" title="1. 三元表达式"></a>1. 三元表达式</h2><p>有时候会出现下面比较疑惑的写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> isTrue === <span class="literal">true</span> ? <span class="string">&#x27;yes&#x27;</span> : <span class="string">&#x27;no&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然 isTrue 已经是布尔类型，为什么不尝试下面这种优雅的写法呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> isTrue ? <span class="string">&#x27;yes&#x27;</span> : <span class="string">&#x27;no&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/21/js%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E2%80%94%E2%80%94%E5%81%A5%E5%A3%AE%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wk的博客">
      <meta itemprop="description" content="一个前端程序员">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | wk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/21/js%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E2%80%94%E2%80%94%E5%81%A5%E5%A3%AE%E6%80%A7/" class="post-title-link" itemprop="url">js代码质量——健壮性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-21 13:40:38" itemprop="dateCreated datePublished" datetime="2022-03-21T13:40:38+08:00">2022-03-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 17:48:17" itemprop="dateModified" datetime="2023-05-07T17:48:17+08:00">2023-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>对于初入职场的我们，最重要的就是学习如何写出高质量的 js 代码。学习的途径也很简单，多看，多写，多总结：</p>
<ul>
<li>多看：看大佬们写的代码，学习他们智慧的结晶</li>
<li>多写：纸上得来终觉浅，不停的敲代码才能发现自己的问题，提升自己</li>
<li>多总结：我一直以来奉行的学习方法有两种——<strong>问题驱动学习</strong>和<strong>输出倒闭输入</strong>。只有自己认真的思考总结过，才能发现很多问题的细节，真正的去掌握知识。</li>
</ul>
<p>当然，<strong>我也是一个初入前端的小菜鸡</strong>，本篇博客有内容或认知上的错误属于正常现象，希望各位观众老爷们不吝赐教。本篇博客也不是一次就完成，后面每次小猪遇到新的问题都会跟进博客，当然也欢迎大家来评论区补充！</p>
<h2 id="0-什么是代码健壮性？"><a href="#0-什么是代码健壮性？" class="headerlink" title="0 什么是代码健壮性？"></a>0 什么是代码健壮性？</h2><p>在学校看论文时就经常遇到鲁棒性，在公司学习时经常听到其他人提到代码的健壮性，所以每每听到周会大佬们讨论时都会莫名觉厉。</p>
<p>健壮性，顾名思义，健康强壮。拿这个词来形容人，就是说明这个人身体健康强壮，在遇到小感冒，跌打损伤，不会让他卧床不起。拿这个词来形容代码，道理也一样，在代码遇到各种个样的异常问题，如读取一个值不是预期类型、查询不到指定的路径等，代码不会轻易的挂掉，而是有它自己的一套措施。</p>
<p>如果你的代码现在还有一碰就倒，并且一蹶不振的现象。不用担心，这篇文章就是帮助你的代码变强的修炼秘籍。</p>
<p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fdingyue.ws.126.net%2F2020%2F0614%2Fbc9bb44ep00qbw7zv0061c000zt00plc.png&refer=http%3A%2F%2Fdingyue.ws.126.net&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1650426335&t=48153ed46627f80e9cd2ff67a9068c66" alt="strong"></p>
<h2 id="1-函数"><a href="#1-函数" class="headerlink" title="1 函数"></a>1 函数</h2><p><strong>一、函数默认参数妙用</strong></p>
<p><strong>场景：</strong></p>
<p>假设我们又如下的初始化工作需要进行，在代码的最开始我们需要对<code>config</code>对象进行初始化工作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initConfig</span>(<span class="params">config</span>) &#123;</span><br><span class="line">    config.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        item.<span class="property">content</span> = <span class="title class_">Number</span>(item.<span class="property">content</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们不小心忘记给它传递参数，浏览器会报如下错误，提示我们 config 没有 map 方法，因为此时 config 为 undefined</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b0a1055f039343268ed3f1bc6ca600a2~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><strong>解决办法：</strong></p>
<p>我们可以给函数的参数加上一个默认的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initConfig</span>(<span class="params">config = []</span>) &#123;</span><br><span class="line">    config.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        item.<span class="property">content</span> = <span class="title class_">Number</span>(item.<span class="property">content</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>这里我们可以默认设置其他的类型，如字符串、数字、对象等，提高代码的健壮性</p>
<h2 id="2-解构赋值"><a href="#2-解构赋值" class="headerlink" title="2 解构赋值"></a>2 解构赋值</h2><p>**解构： **  ES6 允许按照一定模式，从数组和对象中提取值，对变量进行赋值，这被称为解构</p>
<p><strong>一、数组</strong></p>
<p><strong>场景：</strong></p>
<p>假设我们需要一个数组的值分别给几个变量，我们会使用数组的解构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleArr</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [a, b, c] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> a + b + c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们需要结构的数组不能确定值百分之百正确时，也就是没有多或者少时，我们任然按照上面的写法便会出现问题</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a172ac80e8643bfb4ab4edc9cdebae0~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><strong>解决办法：</strong></p>
<p>给解构赋值指定默认值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleArr</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> a + b + c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="title function_">handleArr</span>(arr)	<span class="comment">// 6</span></span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>开发时常用到这种方法一次取出多个值，但是要考虑到解构的值不存在的情况，设置好默认值提高代码的健壮性</p>
<p><strong>二、对象</strong></p>
<p><strong>场景：</strong></p>
<p>对象的场景和数组的原理是一样，只不过对象解构的场景用到得更多。</p>
<p><strong>解决办法：</strong></p>
<p>给对象解构赋值指定默认值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleObj</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name, list = [] &#125; = obj</span><br><span class="line">  <span class="keyword">if</span>(name) &#123;</span><br><span class="line">    list.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;add1&#x27;</span>,</span><br><span class="line">  <span class="attr">list</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>对象解构的内容可能是字符串、数字、数组或是对象等，对于不同的变量类型，我们需要指定不同的默认值，确保代码的健壮性</p>
<h2 id="3-接口请求"><a href="#3-接口请求" class="headerlink" title="3 接口请求"></a>3 接口请求</h2><p>前面两点讨论的是不要轻易相信前端自己的数据，那么从后端接口传来的数据就更不要轻易相信。</p>
<p><strong>一、后端响应的数据</strong></p>
<p><strong>场景：</strong></p>
<p>假设后后端规定接口响应的内容如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">msg</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">data</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们前端代码可能会这样写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; code, msg, data &#125;  = <span class="keyword">await</span> <span class="title function_">fetchList</span>()</span><br><span class="line">  data.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果后端接口出现了异常</p>
<ul>
<li>后端接口挂掉，取出来的 data 为 undefined</li>
<li>后端返回的 data 出现异常，不是数组</li>
<li>….</li>
</ul>
<p>那么代码中执行的 map 方法就会报错</p>
<p><strong>解决办法：</strong></p>
<p>为了防止接口不反回 data 字段，我们可以给解构指定默认值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; code, msg, data = [] &#125;  = <span class="keyword">await</span> <span class="title function_">fetchList</span>()</span><br><span class="line">  data.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了防止接口返回的是数组，我们可以对类型进行检查</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; code, msg, data = [] &#125;  = <span class="keyword">await</span> <span class="title function_">fetchList</span>()</span><br><span class="line">  <span class="title class_">Array</span>.<span class="title function_">isArray</span>(data) &amp;&amp; data.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>我们约定好的接口传过来的数据可能出现数据不存在，类型对不上等异常错误，在相应地方加上异常的处理提高代码的健壮性</p>
<p><strong>二、异常捕获</strong></p>
<blockquote>
<p>除了接口数据的处理，我们还要做好异常的处理，这里参考一篇博客：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6996315680651870244">JavaScript 中的异常处理</a></p>
</blockquote>
<h2 id="4-lodash"><a href="#4-lodash" class="headerlink" title="4 lodash"></a>4 lodash</h2><p>在进行业务开发时，经常会忽略一些代码健壮性考虑的地方。我们可以使用现有的工具库提升代码健壮性，同时也可以让开发者更关注于业务逻辑的开发。这里推荐的工具库是 lodash。</p>
<blockquote>
<p>文档传送门：<a target="_blank" rel="noopener" href="https://www.lodashjs.com/docs/lodash.get">Lodash中文文档</a></p>
</blockquote>
<p><strong>一、取 object 值</strong></p>
<p>我们在上面提到了使用解构的方法取对象的值，在这里我们可以使用<code>_.get()</code>方法，进而不用再关注可能出现的异常。</p>
<p><strong>方法：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.<span class="title function_">get</span>(object, path, [defaultValue])</span><br></pre></td></tr></table></figure>

<p>根据 <code>object</code>对象的<code>path</code>路径获取值。 如果解析 value 是 <code>undefined</code> 会以 <code>defaultValue</code> 取代。</p>
<p><strong>参数：</strong></p>
<ol>
<li><code>bject</code> <em>(Object)</em>: 要检索的对象。</li>
<li><code>path</code> <em>(Array|string)</em>: 要获取属性的路径。</li>
<li><code>[defaultValue]</code> <em>(*)</em>: 如果解析值是 <code>undefined</code> ，这值会被返回。</li>
</ol>
<p><strong>返回值：</strong></p>
<p>返回解析的值。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wk</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
